<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÊåáÊå•Â∑•‰ΩúÁ≥ªÁªü V5.0</title>
    <style>
        /* Âü∫Á°ÄÊ†∑Âºè */
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --danger: #dc2626;
            --light: #f8fafc;
            --dark: #0f172a;
            --success: #16a34a;
            --warning: #d97706;
            --media-limit: #f59e0b;
            --search-highlight: #ffeb3b;
            --gray-light: #e5e7eb;
            --gray-medium: #9ca3af;
            --legal-primary: #059669;
            --legal-secondary: #047857;
            --notice-primary: #d97706;
            --notice-secondary: #b45309;
            --info-primary: #0ea5e9;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #0c4a6e 100%);
            padding: 12px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-x: hidden;
        }
        
        /* ‰∏ªÂÆπÂô® */
        .app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            overflow: hidden;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Â§¥ÈÉ®Ê†∑Âºè */
        .header {
            background: linear-gradient(to right, #1e3a8a, #2563eb);
            color: white;
            padding: 18px 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .system-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* Á≥ªÁªüÂàáÊç¢Âô® */
        .system-switcher {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .system-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .system-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .system-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .system-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 5px;
        }
        
        /* Ê≠•È™§ÊåáÁ§∫Âô® */
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }
        
        .step {
            min-width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #93c5fd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1e3a8a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-size: 0.9rem;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .step:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
        }
        
        .step.active {
            background: white;
            color: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 0 0 3px white;
        }
        
        /* ÂÜÖÂÆπÂå∫Âüü */
        .content {
            padding: 20px;
            min-height: 65vh;
            background: #f0f9ff;
            position: relative;
        }
        
        .system-content {
            display: none;
        }
        
        .system-content.active {
            display: block;
        }
        
        .step-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-content.active {
            display: block;
        }
        
        h2 {
            color: var(--secondary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dbeafe;
            display: flex;
            align-items: center;
            font-size: 1.25rem;
        }
        
        h2 .icon {
            margin-right: 10px;
            font-size: 1.4rem;
        }
        
        /* Á¨¨‰∏ÄÊ≠•ÔºöË≠¶ÊÉÖÁ±ªÂûãÈÄâÊã© */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box {
            width: 100%;
            padding: 14px 45px 14px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-medium);
            font-size: 1.2rem;
        }
        
        .search-hint {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--gray-medium);
            padding-left: 5px;
        }
        
        .case-types-container {
            margin-top: 15px;
            position: relative;
        }
        
        .case-types-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .case-types-title {
            font-weight: bold;
            color: var(--secondary);
            font-size: 1.1rem;
        }
        
        .case-actions {
            display: flex;
            gap: 10px;
        }
        
        .scroll-indicator {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
            user-select: none;
        }
        
        .scroll-indicator:hover, .scroll-indicator:active {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        
        .scroll-indicator .icon {
            font-size: 0.9rem;
            transition: transform 0.3s;
        }
        
        .scroll-indicator.expanded .icon {
            transform: rotate(180deg);
        }
        
        .case-types-scroll {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            max-height: 320px;
            overflow-y: auto;
            padding-right: 5px;
            transition: max-height 0.3s ease;
            -webkit-overflow-scrolling: touch;
        }
        
        .case-types-scroll.collapsed {
            overflow-y: hidden;
        }
        
        .case-types-scroll.expanded {
            max-height: 600px;
        }
        
        /* Ë≠¶ÊÉÖÁ±ªÂûãÊåâÈíÆ */
        .case-btn {
            background: var(--light);
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            padding: 16px 10px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            min-height: 100px;
            user-select: none;
        }
        
        .case-btn:hover, .case-btn:active {
            border-color: var(--primary);
            background: #dbeafe;
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .case-btn.selected {
            border-color: var(--primary);
            background: #dbeafe;
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            animation: pulse 0.5s ease;
        }
        
        @keyframes pulse {
            0% { transform: translateY(-3px) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
            100% { transform: translateY(-3px) scale(1); }
        }
        
        .case-btn.selected::after {
            content: "‚úì";
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
            animation: fadeIn 0.3s ease;
        }
        
        .case-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        .case-name {
            font-size: 0.9rem;
            line-height: 1.3;
        }
        
        .case-actions-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .case-btn:hover .case-actions-btn {
            opacity: 1;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        /* Ê∑ªÂä†Ë≠¶ÊÉÖÊåâÈíÆ */
        .add-case-btn {
            background: #f0f9ff;
            border: 2px dashed var(--gray-light);
            border-radius: 10px;
            padding: 16px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 100px;
            color: var(--gray-medium);
        }
        
        .add-case-btn:hover {
            border-color: var(--primary);
            background: #dbeafe;
            color: var(--primary);
            transform: translateY(-3px);
        }
        
        .add-icon {
            font-size: 2rem;
            color: var(--gray-medium);
        }
        
        .add-case-btn:hover .add-icon {
            color: var(--primary);
        }
        
        /* Ê≥ïÂæãËß£ÈáäÊ†∑Âºè */
        .legal-explanation {
            background: #f0fdf4;
            border-radius: 12px;
            padding: 18px;
            border: 2px solid #bbf7d0;
            margin-bottom: 25px;
        }
        
        .legal-explanation h3 {
            color: var(--legal-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .legal-explanation h3 .icon {
            font-size: 1.3rem;
        }
        
        .legal-content {
            line-height: 1.7;
            font-size: 0.95rem;
            color: #334155;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #d1fae5;
        }
        
        .legal-content p {
            margin-bottom: 12px;
        }
        
        .legal-content strong {
            color: var(--legal-primary);
        }
        
        /* Ê≥®ÊÑè‰∫ãÈ°πÊ†∑Âºè */
        .notice-content {
            line-height: 1.7;
            font-size: 0.95rem;
            color: #334155;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #fed7aa;
        }
        
        .notice-content p {
            margin-bottom: 12px;
        }
        
        .notice-content strong {
            color: var(--notice-primary);
        }
        
        .notice-content ul, .notice-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }
        
        .notice-content li {
            margin-bottom: 8px;
        }
        
        .legal-tabs {
            display: flex;
            border-bottom: 2px solid #d1fae5;
            margin-bottom: 15px;
        }
        
        .legal-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #64748b;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .legal-tab.active {
            color: var(--legal-primary);
            border-bottom-color: var(--legal-primary);
            background: #f0fdf4;
        }
        
        .legal-tab:hover {
            background: #dcfce7;
        }
        
        /* Ê≥®ÊÑè‰∫ãÈ°πÊ†áÁ≠æÊ†∑Âºè */
        .legal-tab.notice-tab.active {
            color: var(--notice-primary);
            border-bottom-color: var(--notice-primary);
            background: #fffbeb;
        }
        
        .legal-tab.notice-tab:hover {
            background: #fef3c7;
        }
        
        .legal-tab-content {
            display: none;
        }
        
        .legal-tab-content.active {
            display: block;
        }
        
        /* Áé∞Âú∫ÁôªËÆ∞Á≥ªÁªüÊ†∑Âºè */
        .module {
            margin-bottom: 25px;
            background: white;
            border-radius: 12px;
            padding: 18px;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .module-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            font-size: 1.05rem;
        }
        
        .module-title .icon {
            margin-right: 10px;
            font-size: 1.3rem;
        }
        
        textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            min-height: 110px;
            font-size: 0.95rem;
            margin-bottom: 20px;
            transition: border 0.3s;
            background: #f8fafc;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .media-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .media-counter {
            background: var(--primary);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            margin-top: 15px;
            min-height: 60px;
        }
        
        .media-item {
            aspect-ratio: 1/1;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            background: #f1f5f9;
        }
        
        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .media-item .delete {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .media-item .delete:hover {
            transform: scale(1.1);
        }
        
        .media-item .media-type-badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 5;
        }
        
        .media-item .video-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: white;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 5;
        }
        
        .media-item .video-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        .media-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .media-btn {
            flex: 1;
            padding: 12px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .media-btn:hover, .media-btn:active {
            background: #dbeafe;
            transform: translateY(-2px);
        }
        
        .media-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .media-btn .icon {
            font-size: 1.4rem;
        }
        
        /* ÊåâÈíÆÊ†∑Âºè */
        .btn {
            padding: 14px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 0.95rem;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
            user-select: none;
        }
        
        .btn:hover, .btn:active {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(37, 99, 235, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            box-shadow: none;
        }
        
        .btn-outline:hover, .btn-outline:active {
            background: #dbeafe;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            box-shadow: 0 4px 6px rgba(22, 163, 74, 0.3);
        }
        
        .btn-success:hover, .btn-success:active {
            background: #15803d;
            box-shadow: 0 6px 10px rgba(22, 163, 74, 0.4);
        }
        
        .btn-danger {
            background: var(--danger);
            box-shadow: 0 4px 6px rgba(220, 38, 38, 0.3);
        }
        
        .btn-danger:hover, .btn-danger:active {
            background: #b91c1c;
            box-shadow: 0 6px 10px rgba(220, 38, 38, 0.4);
        }
        
        .btn-warning {
            background: var(--warning);
            box-shadow: 0 4px 6px rgba(217, 119, 6, 0.3);
        }
        
        .btn-warning:hover, .btn-warning:active {
            background: #b45309;
            box-shadow: 0 6px 10px rgba(217, 119, 6, 0.4);
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        /* ËßÅËØÅ‰∫∫Êéß‰ª∂ */
        .witness-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            align-items: center;
        }
        
        /* Ê±áÊÄªÈ°µÈù¢Ê†∑Âºè */
        .summary-folder {
            background: #eff6ff;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid #dbeafe;
        }
        
        .folder-item {
            padding: 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .folder-item:hover {
            transform: translateX(5px);
        }
        
        .folder-item .status {
            color: var(--success);
            font-weight: bold;
            font-size: 1rem;
        }
        
        .folder-item .status-danger {
            color: var(--danger);
            font-weight: bold;
            font-size: 1rem;
        }
        
        /* Â∑•‰ΩúÊä•Âëä */
        .work-report {
            background: #f0fdf4;
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #bbf7d0;
            margin-bottom: 20px;
        }
        
        .work-report h3 {
            margin-bottom: 15px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .work-report-content {
            line-height: 1.8;
            font-size: 0.95rem;
        }
        
        .work-report-content div {
            margin-bottom: 8px;
        }
        
        /* ÂØºÂá∫ÈÄâÈ°π */
        .export-options {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        
        .export-card {
            width: 100%;
            max-width: 300px;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .export-card:hover, .export-card:active {
            border-color: var(--primary);
            background: #dbeafe;
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .export-card h3 {
            margin-bottom: 5px;
            color: var(--secondary);
            font-size: 1.05rem;
        }
        
        .export-card .icon {
            font-size: 2.2rem;
            color: var(--primary);
        }
        
        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .modal-title {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #334155;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
            transition: all 0.3s;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .case-types-scroll::-webkit-scrollbar,
        .legal-content::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar,
        .notice-content::-webkit-scrollbar,
        .media-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .case-types-scroll::-webkit-scrollbar-track,
        .legal-content::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track,
        .notice-content::-webkit-scrollbar-track,
        .media-grid::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .case-types-scroll::-webkit-scrollbar-thumb,
        .legal-content::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb,
        .notice-content::-webkit-scrollbar-thumb,
        .media-grid::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        
        .case-types-scroll::-webkit-scrollbar-thumb:hover,
        .legal-content::-webkit-scrollbar-thumb:hover,
        .modal-content::-webkit-scrollbar-thumb:hover,
        .notice-content::-webkit-scrollbar-thumb:hover,
        .media-grid::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* ÊêúÁ¥¢ÁªìÊûúÁä∂ÊÄÅ */
        .search-results-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--gray-medium);
            text-align: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        /* ÊèêÁ§∫‰ø°ÊÅØ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 80%;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* È°µËÑö */
        .footer {
            text-align: center;
            padding: 15px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.85rem;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Á©∫ÁΩëÊ†ºÊ∂àÊÅØ */
        .empty-grid-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        /* Á≥ªÁªü‰ø°ÊÅØÈù¢Êùø */
        .system-info {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 18px;
            margin-top: 25px;
            border: 2px solid #dbeafe;
        }
        
        .system-info h3 {
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .system-info-content {
            line-height: 1.8;
            font-size: 0.95rem;
            color: #334155;
        }
        
        .system-info-content div {
            margin-bottom: 8px;
        }
        
        /* Âà†Èô§ÊåâÈíÆÂå∫Âüü */
        .delete-action {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-light);
            text-align: center;
        }
        
        /* ÂõûÊî∂Á´ôÈ°πÁõÆÊ†∑Âºè */
        .recycle-bin-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recycle-bin-item-info {
            flex: 1;
        }
        
        .recycle-bin-item-type {
            display: inline-block;
            background: #e5e7eb;
            color: #4b5563;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-bottom: 5px;
        }
        
        .recycle-bin-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .recycle-bin-item-time {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        .recycle-bin-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .recycle-bin-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        .recycle-bin-empty .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        /* Âä†ÂØÜÊ®°ÊÄÅÊ°Ü */
        .encryption-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .encryption-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .password-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .password-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        
        .modal-buttons .btn {
            flex: 1;
            padding: 12px;
        }
        
        .password-hint {
            margin-top: 15px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
            color: #64748b;
        }
        
        /* Â™í‰ΩìÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü */
        .media-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .media-preview-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .preview-content {
            width: 90%;
            max-width: 800px;
            position: relative;
        }
        
        .preview-content img, 
        .preview-content video {
            width: 100%;
            max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255,255,255,0.1);
        }
        
        .close-preview {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--danger);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .close-preview:hover {
            transform: scale(1.1);
        }
        
        /* ÂØºÂÖ•ÈÄâÈ°πÂç°Ê†∑Âºè */
        .import-tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-light);
            margin-bottom: 20px;
        }
        
        .import-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #64748b;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
        }
        
        .import-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #eff6ff;
        }
        
        .import-tab:hover {
            background: #dbeafe;
        }
        
        .import-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .import-tab-content.active {
            display: block;
        }
        
        /* ÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅÊåáÁ§∫Âô® */
        .env-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .env-status.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: var(--success);
        }
        
        .env-status.warning {
            background: #fffbeb;
            border: 1px solid #fef3c7;
            color: var(--warning);
        }
        
        .env-status.error {
            background: #fef2f2;
            border: 1px solid #fee2e2;
            color: var(--danger);
        }
        
        .env-status.info {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            color: var(--primary);
        }
        
        /* ExcelÁä∂ÊÄÅ */
        .excel-status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
        }
        
        .excel-status.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: var(--success);
        }
        
        .excel-status.error {
            background: #fef2f2;
            border: 1px solid #fee2e2;
            color: var(--danger);
        }
        
        .excel-status.info {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            color: var(--primary);
        }
        
        /* ÈöêËóèÂÖÉÁ¥† */
        .hidden {
            display: none;
        }
        
        /* ËæìÂÖ•Ê°ÜÈöêËóè */
        #cameraInput, #videoInput {
            display: none;
        }
        
        /* ‰∏ãËΩΩËøõÂ∫¶ */
        .download-progress {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* ÂõæÊ†áÊ†∑Âºè */
        .suspect-icon {
            background-color: #fef3c7;
            color: #d97706;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-right: 10px;
        }
        
        .victim-icon {
            background-color: #fee2e2;
            color: #dc2626;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-right: 10px;
        }
        
        /* Â™í‰ΩìËÆ°Êï∞Âô®Ë≠¶Âëä */
        .media-counter-warning {
            background: var(--media-limit);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* ÁéØÂ¢ÉÂ∫ìÂäüËÉΩÊåâÈíÆ */
        .env-functions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .env-btn {
            padding: 12px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .env-btn:hover {
            background: #dbeafe;
            transform: translateY(-2px);
        }
        
        /* ÂéãÁº©ËøõÂ∫¶ÊèêÁ§∫ */
        .compression-status {
            background: #eff6ff;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            border: 2px solid #dbeafe;
        }
        
        .compression-status h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .compression-progress {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .compression-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #1e40af);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .compression-details {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #64748b;
        }
        
        /* ÈÄÇÈÖçÁßªÂä®ËÆæÂ§á */
        @media (max-width: 768px) {
            .case-types-scroll {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 10px;
            }
            
            .case-btn {
                min-height: 90px;
                padding: 14px 8px;
            }
            
            .case-name {
                font-size: 0.85rem;
            }
            
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .content {
                padding: 15px;
            }
            
            .header {
                padding: 15px 20px;
            }
            
            .step-indicator {
                gap: 5px;
            }
            
            .step {
                min-width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            
            .legal-tabs {
                flex-wrap: wrap;
            }
            
            .legal-tab {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .system-controls {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }
            
            .system-switcher {
                gap: 8px;
            }
            
            .system-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .import-tabs {
                flex-wrap: wrap;
            }
            
            .import-tab {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .case-types-scroll {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }
            
            .nav-buttons .btn {
                padding: 12px 18px;
                font-size: 0.9rem;
            }
            
            .module {
                padding: 15px;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÊåáÊå•Â∑•‰ΩúÁ≥ªÁªü V5.0</h1>
            <p>Ë≠¶ÊÉÖÂ§ÑÁΩÆ‰∏éÁé∞Âú∫ÁôªËÆ∞‰∏Ä‰ΩìÂåñÂπ≥Âè∞</p>
            
            <div class="system-controls">
                <button class="control-btn" id="importBtn">
                    <span class="icon">üì•</span> ÂØºÂÖ•
                </button>
                <button class="control-btn" id="exportBtn">
                    <span class="icon">üì§</span> ÂØºÂá∫
                </button>
                <button class="control-btn" id="recycleBinBtn">
                    <span class="icon">üóëÔ∏è</span> ÂõûÊî∂Á´ô
                </button>
            </div>
            
            <div class="system-switcher">
                <button class="system-btn active" onclick="switchSystem('case')">
                    <span class="icon">‚öñÔ∏è</span> Ë≠¶ÊÉÖÂ§ÑÁΩÆ
                    <span class="system-badge">V4.0</span>
                </button>
                <button class="system-btn" onclick="switchSystem('field')">
                    <span class="icon">üì∏</span> Áé∞Âú∫ÁôªËÆ∞
                    <span class="system-badge">V3.4</span>
                </button>
            </div>
        </div>
        
        <div class="content">
            <!-- Ë≠¶ÊÉÖÂ§ÑÁΩÆÁ≥ªÁªü -->
            <div id="caseSystem" class="system-content active">
                <div class="step-indicator">
                    <div class="step active" onclick="goToStep(1, 'case')">1</div>
                    <div class="step" onclick="goToStep(2, 'case')">2</div>
                </div>
                
                <!-- Á¨¨1Ê≠•ÔºöË≠¶ÊÉÖÁ±ªÂûãÈÄâÊã© -->
                <div id="caseStep1" class="step-content active">
                    <h2><span class="icon">üìã</span> ÈÄâÊã©Ë≠¶ÊÉÖÁ±ªÂûã</h2>
                    
                    <div class="search-container">
                        <input type="text" class="search-box" id="caseSearch" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆÂ≠óÊêúÁ¥¢Ë≠¶ÊÉÖÁ±ªÂûãÔºåÂ¶ÇÔºöÊâìÊû∂„ÄÅÊê∫Â∏¶„ÄÅÊªã‰∫ã..." autocomplete="off">
                        <div class="search-icon">üîç</div>
                        <div class="search-hint">ÊîØÊåÅÊ®°Á≥äÊêúÁ¥¢ÔºåËæìÂÖ•‰ªªÊÑèÂÖ≥ÈîÆÂ≠óÂç≥ÂèØÂåπÈÖçÁõ∏ÂÖ≥Ë≠¶ÊÉÖÁ±ªÂûã</div>
                    </div>
                    
                    <div class="case-types-container">
                        <div class="case-types-header">
                            <div class="case-types-title">Ë≠¶ÊÉÖÁ±ªÂûãÂ∫ì</div>
                            <div class="case-actions">
                                <div class="scroll-indicator" id="scrollIndicator" onclick="toggleExpandCases()">
                                    <span id="indicatorText">Â±ïÂºÄÊõ¥Â§ö</span>
                                    <span class="icon">‚ñº</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="case-types-scroll collapsed" id="caseTypesScroll">
                            <!-- Ë≠¶ÊÉÖÁ±ªÂûãÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        
                        <div id="searchResultsInfo" class="search-results-info" style="display: none;">
                            Ê≠£Âú®ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú...
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <div></div>
                        <button class="btn" onclick="nextStep(1, 'case')">
                            Êü•ÁúãÊ≥ïÂæãËß£Èáä <span class="icon">‚Üí</span>
                        </button>
                    </div>
                </div>
                
                <!-- Á¨¨2Ê≠•ÔºöÊ≥ïÂæãËß£ÈáäÔºàÂåÖÂê´Ê≥®ÊÑè‰∫ãÈ°πÔºâ -->
                <div id="caseStep2" class="step-content">
                    <h2><span class="icon">‚öñÔ∏è</span> Ê≥ïÂæãËß£Èáä</h2>
                    
                    <div class="legal-explanation">
                        <div class="legal-tabs">
                            <div class="legal-tab active" onclick="switchLegalTab('law')">Ê≥ïÂæãÊ≥ïËßÑ</div>
                            <div class="legal-tab" onclick="switchLegalTab('interpretation')">Âè∏Ê≥ïËß£Èáä</div>
                            <div class="legal-tab notice-tab" onclick="switchLegalTab('notice')">Ê≥®ÊÑè‰∫ãÈ°π</div>
                            <div class="legal-tab" onclick="showEditLegalModal()">ÁºñËæëÊ≥ïÂæãËß£Èáä</div>
                        </div>
                        
                        <div id="lawContent" class="legal-tab-content active">
                            <h3><span class="icon">üî®</span> Áõ∏ÂÖ≥Ê≥ïÂæãÊ≥ïËßÑ</h3>
                            <div class="legal-content" id="lawText">
                                <!-- Ê≥ïÂæãÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                            </div>
                        </div>
                        
                        <div id="interpretationContent" class="legal-tab-content">
                            <h3><span class="icon">üèõÔ∏è</span> Áõ∏ÂÖ≥Âè∏Ê≥ïËß£Èáä</h3>
                            <div class="legal-content" id="interpretationText">
                                <!-- Âè∏Ê≥ïËß£ÈáäÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                            </div>
                        </div>
                        
                        <div id="noticeContent" class="legal-tab-content">
                            <h3><span class="icon">‚ö†Ô∏è</span> Ê≥®ÊÑè‰∫ãÈ°π</h3>
                            <div class="notice-content" id="noticeText">
                                <!-- Ê≥®ÊÑè‰∫ãÈ°πÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-outline" onclick="prevStep(2, 'case')">
                            <span class="icon">‚Üê</span> ËøîÂõûÈÄâÊã©
                        </button>
                        <button class="btn" onclick="switchSystem('field')">
                            ËøõÂÖ•Áé∞Âú∫ÁôªËÆ∞ <span class="icon">üì∏</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Áé∞Âú∫ÁôªËÆ∞Á≥ªÁªü -->
            <div id="fieldSystem" class="system-content">
                <div class="step-indicator">
                    <div class="step active" onclick="goToStep(1, 'field')">1</div>
                    <div class="step" onclick="goToStep(2, 'field')">2</div>
                    <div class="step" onclick="goToStep(3, 'field')">3</div>
                    <div class="step" onclick="goToStep(4, 'field')">4</div>
                    <div class="step" onclick="goToStep(5, 'field')">5</div>
                    <div class="step" onclick="goToStep(6, 'field')">6</div>
                </div>
                
                <!-- Á¨¨1Ê≠•ÔºöÁé∞Âú∫ÊÉÖÂÜµÁôªËÆ∞ -->
                <div id="fieldStep1" class="step-content active">
                    <h2><span class="icon">üì∏</span> 1.Áé∞Âú∫ÊÉÖÂÜµÁôªËÆ∞</h2>
                    <div class="module">
                        <div class="module-title">
                            <span class="icon">üìù</span> Áé∞Âú∫ÊÉÖÂÜµÊèèËø∞
                        </div>
                        <textarea id="sceneDesc" placeholder="ËØ∑ËØ¶ÁªÜÊèèËø∞Áé∞Âú∫ÊÉÖÂÜµÔºö&#10;Êó∂Èó¥Ôºö&#10;Âú∞ÁÇπÔºö&#10;‰∫ãÊÉÖÁªèËøáÔºö&#10;ÂÖ∂‰ªñ‰ø°ÊÅØ..."></textarea>
                    </div>
                    
                    <div class="module">
                        <div class="media-header">
                            <div class="module-title">
                                <span class="icon">üì∑</span> Áé∞Âú∫ÁÖßÁâá/ËßÜÈ¢ëÁôªËÆ∞
                            </div>
                            <div id="sceneCounter" class="media-counter">0/99</div>
                        </div>
                        <div class="media-grid" id="sceneMedia">
                            <div class="empty-grid-message">ÊöÇÊó†Â™í‰ΩìÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†</div>
                        </div>
                        <div class="media-controls">
                            <div class="media-btn" onclick="openCamera('sceneMedia')">
                                <span class="icon">üì∑</span>
                                <div>ÊãçÁÖß</div>
                            </div>
                            <div class="media-btn" onclick="openVideoRecorder('sceneMedia')">
                                <span class="icon">üé•</span>
                                <div>ÂΩïÂÉè</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <div></div>
                        <button class="btn" onclick="nextStep(1, 'field')">
                            ‰∏ã‰∏ÄÊ≠• <span class="icon">‚Üí</span>
                        </button>
                    </div>
                </div>
                
                <!-- Á¨¨2Ê≠•ÔºöÊä•Ë≠¶‰∫∫‰ø°ÊÅØÁôªËÆ∞ -->
                <div id="fieldStep2" class="step-content">
                    <h2><span class="icon">üë§</span> 2.Êä•Ë≠¶‰∫∫‰ø°ÊÅØÁôªËÆ∞</h2>
                    <div class="module">
                        <div class="module-title">
                            <span class="icon">‚ÑπÔ∏è</span> Êä•Ë≠¶‰∫∫‰ø°ÊÅØ
                        </div>
                        <textarea id="reporterInfo" placeholder="ÂßìÂêçÔºö&#10;ËÅîÁ≥ªÊñπÂºèÔºö&#10;Ë∫´‰ªΩËØÅÂè∑Ôºö&#10;ÂÖ∂‰ªñ‰ø°ÊÅØ..."></textarea>
                    </div>
                    
                    <div class="module">
                        <div class="media-header">
                            <div class="module-title">
                                <span class="icon">üì∑</span> Êä•Ë≠¶‰∫∫ÁÖßÁâá/ËßÜÈ¢ë
                            </div>
                            <div id="reporterCounter" class="media-counter">0/99</div>
                        </div>
                        <div class="media-grid" id="reporterMedia">
                            <div class="empty-grid-message">ÊöÇÊó†Â™í‰ΩìÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†</div>
                        </div>
                        <div class="media-controls">
                            <div class="media-btn" onclick="openCamera('reporterMedia')">
                                <span class="icon">üì∑</span>
                                <div>ÊãçÁÖß</div>
                            </div>
                            <div class="media-btn" onclick="openVideoRecorder('reporterMedia')">
                                <span class="icon">üé•</span>
                                <div>ÂΩïÂÉè</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-outline" onclick="prevStep(2, 'field')">
                            <span class="icon">‚Üê</span> ‰∏ä‰∏ÄÊ≠•
                        </button>
                        <button class="btn" onclick="nextStep(2, 'field')">
                            ‰∏ã‰∏ÄÊ≠• <span class="icon">‚Üí</span>
                        </button>
                    </div>
                </div>
                
                <!-- Á¨¨3Ê≠•ÔºöË¢´ÂÆ≥‰∫∫‰ø°ÊÅØÁôªËÆ∞ -->
                <div id="fieldStep3" class="step-content">
                    <h2><div class="victim-icon">üÜò</div> 3.Ë¢´ÂÆ≥‰∫∫‰ø°ÊÅØÁôªËÆ∞</h2>
                    <div class="module">
                        <div class="module-title">
                            <span class="icon">‚ÑπÔ∏è</span> Ë¢´ÂÆ≥‰∫∫‰ø°ÊÅØ
                        </div>
                        <textarea id="victimInfo" placeholder="ÂßìÂêçÔºö&#10;ËÅîÁ≥ªÊñπÂºèÔºö&#10;Ë∫´‰ªΩËØÅÂè∑Ôºö&#10;ÂÖ∂‰ªñ‰ø°ÊÅØ..."></textarea>
                    </div>
                    
                    <div class="module">
                        <div class="media-header">
                            <div class="module-title">
                                <span class="icon">üì∑</span> Ë¢´ÂÆ≥‰∫∫ÁÖßÁâá/ËßÜÈ¢ë
                            </div>
                            <div id="victimCounter" class="media-counter">0/99</div>
                        </div>
                        <div class="media-grid" id="victimMedia">
                            <div class="empty-grid-message">ÊöÇÊó†Â™í‰ΩìÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†</div>
                        </div>
                        <div class="media-controls">
                            <div class="media-btn" onclick="openCamera('victimMedia')">
                                <span class="icon">üì∑</span>
                                <div>ÊãçÁÖß</div>
                            </div>
                            <div class="media-btn" onclick="openVideoRecorder('victimMedia')">
                                <span class="icon">üé•</span>
                                <div>ÂΩïÂÉè</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-outline" onclick="prevStep(3, 'field')">
                            <span class="icon">‚Üê</span> ‰∏ä‰∏ÄÊ≠•
                        </button>
                        <button class="btn" onclick="nextStep(3, 'field')">
                            ‰∏ã‰∏ÄÊ≠• <span class="icon">‚Üí</span>
                        </button>
                    </div>
                </div>
                
                <!-- Á¨¨4Ê≠•ÔºöÂ´åÁñë‰∫∫‰ø°ÊÅØÁôªËÆ∞ -->
                <div id="fieldStep4" class="step-content">
                    <h2><div class="suspect-icon">‚öñÔ∏è</div> 4.Â´åÁñë‰∫∫‰ø°ÊÅØÁôªËÆ∞</h2>
                    <div class="module">
                        <div class="module-title">
                            <span class="icon">‚ÑπÔ∏è</span> Â´åÁñë‰∫∫‰ø°ÊÅØ
                        </div>
                        <textarea id="suspectInfo" placeholder="ÂßìÂêçÔºö&#10;ËÅîÁ≥ªÊñπÂºèÔºö&#10;Ë∫´‰ªΩËØÅÂè∑Ôºö&#10;ÂÖ∂‰ªñ‰ø°ÊÅØ..."></textarea>
                    </div>
                    
                    <div class="module">
                        <div class="media-header">
                            <div class="module-title">
                                <span class="icon">üì∑</span> Â´åÁñë‰∫∫ÁÖßÁâá/ËßÜÈ¢ë
                            </div>
                            <div id="suspectCounter" class="media-counter">0/99</div>
                        </div>
                        <div class="media-grid" id="suspectMedia">
                            <div class="empty-grid-message">ÊöÇÊó†Â™í‰ΩìÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†</div>
                        </div>
                        <div class="media-controls">
                            <div class="media-btn" onclick="openCamera('suspectMedia')">
                                <span class="icon">üì∑</span>
                                <div>ÊãçÁÖß</div>
                            </div>
                            <div class="media-btn" onclick="openVideoRecorder('suspectMedia')">
                                <span class="icon">üé•</span>
                                <div>ÂΩïÂÉè</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-outline" onclick="prevStep(4, 'field')">
                            <span class="icon">‚Üê</span> ‰∏ä‰∏ÄÊ≠•
                        </button>
                        <button class="btn" onclick="nextStep(4, 'field')">
                            ‰∏ã‰∏ÄÊ≠• <span class="icon">‚Üí</span>
                        </button>
                    </div>
                </div>
                
                <!-- Á¨¨5Ê≠•ÔºöËßÅËØÅ‰∫∫‰ø°ÊÅØÁôªËÆ∞ -->
                <div id="fieldStep5" class="step-content">
                    <h2><span class="icon">üë•</span> 5.ËßÅËØÅ‰∫∫‰ø°ÊÅØÁôªËÆ∞</h2>
                    
                    <!-- ËßÅËØÅ‰∫∫1 -->
                    <div class="module witness-module">
                        <div class="media-header">
                            <div class="module-title">
                                <span class="icon">üë§</span> ËßÅËØÅ‰∫∫ 1
                            </div>
                            <div id="witness1Counter" class="media-counter">0/99</div>
                        </div>
                        <textarea class="witness-info" placeholder="ÂßìÂêçÔºö&#10;ËÅîÁ≥ªÊñπÂºèÔºö&#10;Ë∫´‰ªΩËØÅÂè∑Ôºö&#10;ÂÖ∂‰ªñ‰ø°ÊÅØ..."></textarea>
                        <div class="module-title">
                            <span class="icon">üì∑</span> ËßÅËØÅ‰∫∫ÁÖßÁâá/ËßÜÈ¢ë
                        </div>
                        <div class="media-grid witness-media" id="witness1Media">
                            <div class="empty-grid-message">ÊöÇÊó†Â™í‰ΩìÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†</div>
                        </div>
                        <div class="media-controls">
                            <div class="media-btn" onclick="openCamera('witness1Media')">
                                <span class="icon">üì∑</span>
                                <div>ÊãçÁÖß</div>
                            </div>
                            <div class="media-btn" onclick="openVideoRecorder('witness1Media')">
                                <span class="icon">üé•</span>
                                <div>ÂΩïÂÉè</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Âä®ÊÄÅÊ∑ªÂä†ËßÅËØÅ‰∫∫Âå∫Âüü -->
                    <div id="additionalWitnesses"></div>
                    
                    <div class="witness-controls">
                        <button class="btn btn-outline" onclick="addWitness()">
                            <span class="icon">+</span> Ê∑ªÂä†ËßÅËØÅ‰∫∫
                        </button>
                        <span id="witnessCount">ÂΩìÂâç1‰ΩçËßÅËØÅ‰∫∫</span>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-outline" onclick="prevStep(5, 'field')">
                            <span class="icon">‚Üê</span> ‰∏ä‰∏ÄÊ≠•
                        </button>
                        <button class="btn" onclick="nextStep(5, 'field')">
                            ‰∏ã‰∏ÄÊ≠• <span class="icon">‚Üí</span>
                        </button>
                    </div>
                </div>
                
                <!-- Á¨¨6Ê≠•ÔºöÊï∞ÊçÆÂØºÂá∫ -->
                <div id="fieldStep6" class="step-content">
                    <h2><span class="icon">üì¶</span> 6.Êï∞ÊçÆÂØºÂá∫</h2>
                    
                    <div class="compression-status" id="compressionStatus" style="display: none;">
                        <h3><span class="icon">‚è≥</span> Ê≠£Âú®ÊâìÂåÖÊï∞ÊçÆ...</h3>
                        <div class="compression-progress">
                            <div class="compression-progress-bar" id="compressionProgressBar"></div>
                        </div>
                        <div class="compression-details" id="compressionDetails">
                            Ê≠£Âú®ÂáÜÂ§áÊñá‰ª∂...
                        </div>
                    </div>
                    
                    <div class="work-report">
                        <h3><span class="icon">‚ÑπÔ∏è</span> Êï∞ÊçÆÂØºÂá∫ËØ¥Êòé</h3>
                        <div class="work-report-content">
                            <p><strong>ÂØºÂá∫ÂÜÖÂÆπÔºö</strong>Â∞ÜÁîüÊàê‰∏Ä‰∏™ÂéãÁº©ÂåÖÔºåÂåÖÂê´‰ª•‰∏ãÂÜÖÂÆπÔºö</p>
                            <ul>
                                <li><strong>Â∑•‰ΩúËÆ∞ÂΩï.txt</strong> - ÂåÖÂê´ÊâÄÊúâÁôªËÆ∞ÁöÑÊñáÂ≠ó‰ø°ÊÅØ</li>
                                <li><strong>Áé∞Âú∫ÊÉÖÂÜµ/</strong> - Áé∞Âú∫ÁÖßÁâáÂíåËßÜÈ¢ë</li>
                                <li><strong>Êä•Ë≠¶‰∫∫/</strong> - Êä•Ë≠¶‰∫∫ÁÖßÁâáÂíåËßÜÈ¢ë</li>
                                <li><strong>Ë¢´ÂÆ≥‰∫∫/</strong> - Ë¢´ÂÆ≥‰∫∫ÁÖßÁâáÂíåËßÜÈ¢ë</li>
                                <li><strong>Â´åÁñë‰∫∫/</strong> - Â´åÁñë‰∫∫ÁÖßÁâáÂíåËßÜÈ¢ë</li>
                                <li><strong>ËßÅËØÅ‰∫∫/</strong> - ËßÅËØÅ‰∫∫ÁÖßÁâáÂíåËßÜÈ¢ë</li>
                            </ul>
                            <p><strong>Ê≥®ÊÑè‰∫ãÈ°πÔºö</strong></p>
                            <ol>
                                <li>ÊâÄÊúâÊï∞ÊçÆÊâìÂåÖÊàêZIPÊ†ºÂºèÔºåÊñπ‰æø‰º†ËæìÂíåÂ≠òÂÇ®</li>
                                <li>ÁÖßÁâáÂíåËßÜÈ¢ë‰øùÊåÅÂéüÂßãË¥®Èáè</li>
                                <li>ÂØºÂá∫ËøáÁ®ãÂèØËÉΩÈúÄË¶ÅÂá†ÁßíÈíüÊó∂Èó¥ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ</li>
                                <li>Êï∞ÊçÆ‰ªÖÂú®Êú¨Âú∞Â§ÑÁêÜÔºå‰∏ç‰ºö‰∏ä‰º†Âà∞‰ªª‰ΩïÊúçÂä°Âô®</li>
                            </ol>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 25px; margin-bottom: 15px;"><span class="icon">üíæ</span> ÂØºÂá∫ÈÄâÈ°π</h3>
                    <div class="export-options">
                        <div class="export-card" onclick="generateZipPackage()">
                            <span class="icon">üì¶</span>
                            <h3>ÁîüÊàêÊï∞ÊçÆÂéãÁº©ÂåÖ</h3>
                            <p>ÊâìÂåÖÊâÄÊúâÁÖßÁâá„ÄÅËßÜÈ¢ëÂíåÁôªËÆ∞‰ø°ÊÅØ</p>
                        </div>
                    </div>
                    
                    <div class="nav-buttons">
                        <button class="btn btn-outline" onclick="prevStep(6, 'field')">
                            <span class="icon">‚Üê</span> ‰∏ä‰∏ÄÊ≠•
                        </button>
                        <button class="btn btn-success" onclick="switchSystem('case')">
                            <span class="icon">‚öñÔ∏è</span> ËøîÂõûË≠¶ÊÉÖÂ§ÑÁΩÆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÊåáÊå•Â∑•‰Ωú‰∏Ä‰ΩìÂåñÁ≥ªÁªü | V5.0 | Êï∞ÊçÆ‰øùÂ≠òÂú®Êú¨Âú∞ÊµèËßàÂô® | ÊîØÊåÅExcelÂØºÂÖ•ÂØºÂá∫ | ÊØèÁßçË≠¶ÊÉÖÁ±ªÂûãÁã¨Á´ãÂ∑•‰ΩúËÆ∞ÂΩïÊ®°Êùø
        </div>
    </div>
    
    <!-- Ê®°ÊÄÅÊ°ÜÔºöÊ∑ªÂä†/ÁºñËæëË≠¶ÊÉÖÁ±ªÂûã -->
    <div class="modal" id="addCaseModal">
        <div class="modal-content">
            <div class="modal-title">
                <span class="icon">‚ûï</span>
                <span id="modalTitle">Ê∑ªÂä†Ë≠¶ÊÉÖÁ±ªÂûã</span>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ë≠¶ÊÉÖÂêçÁß∞</label>
                <input type="text" id="caseNameInput" class="form-input" placeholder="‰æãÂ¶ÇÔºöÈùûÊ≥ïÊê∫Â∏¶ÁÆ°Âà∂ÂàÄÂÖ∑">
            </div>
            
            <div class="form-group">
                <label class="form-label">ÂõæÊ†á</label>
                <select id="caseIconSelect" class="form-input">
                    <option value="üî™">üî™ ÂàÄÂÖ∑</option>
                    <option value="üî´">üî´ Êû™ÊîØ</option>
                    <option value="üß®">üß® ÁàÜÁ´π</option>
                    <option value="üëä">üëä ÊÆ¥Êâì</option>
                    <option value="üö´">üö´ Á¶ÅÊ≠¢</option>
                    <option value="üí∫">üí∫ Â∫ß‰Ωç</option>
                    <option value="üö™">üö™ ËΩ¶Èó®</option>
                    <option value="üöÇ">üöÇ ÂàóËΩ¶</option>
                    <option value="üé´">üé´ ËΩ¶Á•®</option>
                    <option value="üõÇ">üõÇ ÂÆâÊ£Ä</option>
                    <option value="‚öîÔ∏è">‚öîÔ∏è Êªã‰∫ã</option>
                    <option value="üöì">üöì Ë≠¶ÂØü</option>
                    <option value="üç∫">üç∫ ÈÜâÈÖí</option>
                    <option value="üß†">üß† Á≤æÁ•û</option>
                    <option value="‚ôø">‚ôø ÊÆãÁñæ</option>
                    <option value="üåç">üåç Ê∂âÂ§ñ</option>
                    <option value="üöß">üöß ÈìÅË∑Ø</option>
                    <option value="ü™®">ü™® Áü≥Â§¥</option>
                    <option value="‚ö†Ô∏è">‚ö†Ô∏è Ë≠¶Âëä</option>
                    <option value="üë§">üë§ ÁõóÁ™É</option>
                    <option value="üó£Ô∏è">üó£Ô∏è Á∫†Á∫∑</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÂÖ≥ÈîÆËØçÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
                <input type="text" id="caseKeywordsInput" class="form-input" placeholder="‰æãÂ¶ÇÔºöÈùûÊ≥ï,Êê∫Â∏¶,ÁÆ°Âà∂,ÂàÄÂÖ∑,ÂàÄ">
                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">ÂÖ≥ÈîÆËØçÁî®‰∫éÊêúÁ¥¢ÔºåÂ§ö‰∏™ÂÖ≥ÈîÆËØçÁî®ÈÄóÂè∑ÂàÜÈöî</div>
            </div>
            
            <!-- Âà†Èô§ÊåâÈíÆÂå∫Âüü -->
            <div class="delete-action" id="deleteAction" style="display: none;">
                <button class="btn btn-danger" id="deleteCaseBtn">
                    <span class="icon">üóëÔ∏è</span> Âà†Èô§ËØ•Ë≠¶ÊÉÖÁ±ªÂûã
                </button>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-outline" onclick="closeModal('addCaseModal')">ÂèñÊ∂à</button>
                <button class="btn btn-success" id="saveCaseBtn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- Ê®°ÊÄÅÊ°ÜÔºöÁºñËæëÊ≥ïÂæãËß£ÈáäÔºàÂåÖÂê´Ê≥®ÊÑè‰∫ãÈ°πÔºâ -->
    <div class="modal" id="editLegalModal">
        <div class="modal-content">
            <div class="modal-title">
                <span class="icon">‚úèÔ∏è</span>
                <span>ÁºñËæëÊ≥ïÂæãËß£Èáä</span>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ë≠¶ÊÉÖÁ±ªÂûã</label>
                <select id="legalCaseSelect" class="form-input">
                    <option value="">ËØ∑ÈÄâÊã©Ë≠¶ÊÉÖÁ±ªÂûã</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ê≥ïÂæãÊ≥ïËßÑÂÜÖÂÆπ</label>
                <textarea id="legalLawInput" class="form-textarea" placeholder="ËØ∑ËæìÂÖ•Áõ∏ÂÖ≥Ê≥ïÂæãÊ≥ïËßÑ..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Âè∏Ê≥ïËß£ÈáäÂÜÖÂÆπ</label>
                <textarea id="legalInterpretationInput" class="form-textarea" placeholder="ËØ∑ËæìÂÖ•Áõ∏ÂÖ≥Âè∏Ê≥ïËß£Èáä..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ê≥®ÊÑè‰∫ãÈ°πÂÜÖÂÆπ</label>
                <textarea id="legalNoticeInput" class="form-textarea" placeholder="ËØ∑ËæìÂÖ•Ê≥®ÊÑè‰∫ãÈ°π..."></textarea>
                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">ÂèØ‰ª•ÂåÖÊã¨ÊâßÊ≥ïË¶ÅÁÇπ„ÄÅÂ∏∏ËßÅÈóÆÈ¢ò„ÄÅÂ§ÑÁΩÆÊµÅÁ®ãÁ≠â</div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-outline" onclick="closeModal('editLegalModal')">ÂèñÊ∂à</button>
                <button class="btn btn-success" id="saveLegalBtn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    
    <!-- Ê®°ÊÄÅÊ°ÜÔºöÂØºÂÖ•Êï∞ÊçÆ‰∏éÂØºÂÖ•ÁéØÂ¢ÉÂ∫ì -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-title">
                <span class="icon">üì•</span>
                <span>ÂØºÂÖ•Êï∞ÊçÆ‰∏éÂØºÂÖ•ÁéØÂ¢ÉÂ∫ì</span>
            </div>
            
            <!-- ÈÄâÈ°πÂç° -->
            <div class="import-tabs">
                <div class="import-tab active" onclick="switchImportTab('data')">ÂØºÂÖ•Êï∞ÊçÆ</div>
                <div class="import-tab" onclick="switchImportTab('env')">ÂØºÂÖ•ÁéØÂ¢ÉÂ∫ì</div>
                <div class="import-tab" onclick="switchImportTab('info')">Á≥ªÁªü‰ø°ÊÅØ</div>
            </div>
            
            <!-- ÂØºÂÖ•Êï∞ÊçÆÈÄâÈ°πÂç° -->
            <div id="importDataTab" class="import-tab-content active">
                <div class="form-group">
                    <label class="form-label">ÈÄâÊã©ExcelÊñá‰ª∂ (.xlsx)</label>
                    <input type="file" id="importFileInput" class="form-input" accept=".xlsx,.xls">
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">ËØ∑ÈÄâÊã©‰πãÂâçÂØºÂá∫ÁöÑÁ≥ªÁªüÊï∞ÊçÆExcelÊñá‰ª∂</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÂØºÂÖ•ÈÄâÈ°π</label>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="importCaseTypes" checked style="margin-right: 8px;">
                            <span>ÂØºÂÖ•Ë≠¶ÊÉÖÁ±ªÂûã</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="checkbox" id="importLegalExplanations" checked style="margin-right: 8px;">
                            <span>ÂØºÂÖ•Ê≥ïÂæãËß£Èáä</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÂØºÂÖ•Ê®°Âºè</label>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; margin-bottom: 8px;">
                            <input type="radio" name="importMode" value="replace" checked style="margin-right: 8px;">
                            <span>ÊõøÊç¢Áé∞ÊúâÊï∞ÊçÆ</span>
                        </label>
                        <label style="display: flex; align-items: center;">
                            <input type="radio" name="importMode" value="merge" style="margin-right: 8px;">
                            <span>ÂêàÂπ∂Âà∞Áé∞ÊúâÊï∞ÊçÆ</span>
                        </label>
                    </div>
                </div>
                
                <div id="excelStatus" class="excel-status" style="display: none;"></div>
                
                <div class="form-actions">
                    <button class="btn btn-outline" onclick="closeModal('importModal')">ÂèñÊ∂à</button>
                    <button class="btn btn-success" id="importDataBtn">ÂØºÂÖ•</button>
                </div>
            </div>
            
            <!-- ÂØºÂÖ•ÁéØÂ¢ÉÂ∫ìÈÄâÈ°πÂç° -->
            <div id="importEnvTab" class="import-tab-content">
                <div id="envStatus" class="env-status info">
                    <span class="icon">‚ÑπÔ∏è</span>
                    <span>ÂΩìÂâçÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅÔºöÊú™Âä†ËΩΩ</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ÈÄâÊã©ÁéØÂ¢ÉÂ∫ìÊñá‰ª∂ (.js)</label>
                    <input type="file" id="importEnvFileInput" class="form-input" accept=".js">
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">ËØ∑ÈÄâÊã© xlsx.full.min.js ÁéØÂ¢ÉÂ∫ìÊñá‰ª∂ÔºåÁî®‰∫éExcelÈ´òÁ∫ßÂäüËÉΩ</div>
                </div>
                
                <div class="env-functions">
                    <button class="env-btn" onclick="importEnvironmentLibrary()">
                        <span class="icon">üì•</span> ÂØºÂÖ•ÁéØÂ¢ÉÂ∫ì
                    </button>
                    <button class="env-btn" onclick="testExcelFunctions()">
                        <span class="icon">üß™</span> ÊµãËØïExcelÂäüËÉΩ
                    </button>
                    <button class="env-btn" onclick="showEnvInfo()">
                        <span class="icon">‚ÑπÔ∏è</span> Êü•ÁúãÁéØÂ¢ÉÂ∫ì‰ø°ÊÅØ
                    </button>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-outline" onclick="closeModal('importModal')">ÂÖ≥Èó≠</button>
                </div>
            </div>
            
            <!-- Á≥ªÁªü‰ø°ÊÅØÈÄâÈ°πÂç° -->
            <div id="importInfoTab" class="import-tab-content">
                <div class="form-group">
                    <label class="form-label">Á≥ªÁªü‰ø°ÊÅØ</label>
                    <div id="systemInfoContent" style="background: #f8fafc; padding: 15px; border-radius: 8px; font-size: 0.9rem; line-height: 1.6;">
                        <div><strong>Á≥ªÁªüÁâàÊú¨Ôºö</strong>V5.0</div>
                        <div><strong>ExcelÁéØÂ¢ÉÂ∫ìÔºö</strong><span id="envLibStatus">Êú™Âä†ËΩΩ</span></div>
                        <div><strong>ÊµèËßàÂô®Ôºö</strong><span id="browserInfo">Êú™Áü•</span></div>
                        <div><strong>Êú¨Âú∞Â≠òÂÇ®‰ΩøÁî®Ôºö</strong><span id="storageUsage">ËÆ°ÁÆó‰∏≠...</span></div>
                        <div><strong>Ë≠¶ÊÉÖÁ±ªÂûãÊï∞ÈáèÔºö</strong><span id="caseTypesCount">0</span></div>
                        <div><strong>Ê≥ïÂæãËß£ÈáäÊï∞ÈáèÔºö</strong><span id="legalCount">0</span></div>
                        <div><strong>Áé∞Âú∫ÁôªËÆ∞Êï∞ÊçÆÔºö</strong><span id="fieldDataStatus">Êó†</span></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Á≥ªÁªüÁª¥Êä§</label>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-outline" onclick="clearAllData()">
                            <span class="icon">üóëÔ∏è</span> Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ
                        </button>
                        <button class="btn btn-outline" onclick="exportSystemConfig()">
                            <span class="icon">üíæ</span> ÂØºÂá∫Á≥ªÁªüÈÖçÁΩÆ
                        </button>
                        <button class="btn btn-outline" onclick="importSystemConfig()">
                            <span class="icon">üì•</span> ÂØºÂÖ•Á≥ªÁªüÈÖçÁΩÆ
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-outline" onclick="closeModal('importModal')">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ê®°ÊÄÅÊ°ÜÔºöÂõûÊî∂Á´ô -->
    <div class="modal" id="recycleBinModal">
        <div class="modal-content">
            <div class="modal-title">
                <span class="icon">üóëÔ∏è</span>
                <span>ÂõûÊî∂Á´ô</span>
            </div>
            
            <div id="recycleBinContent">
                <!-- ÂõûÊî∂Á´ôÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
            
            <div class="form-actions">
                <button class="btn btn-outline" onclick="closeModal('recycleBinModal')">ÂÖ≥Èó≠</button>
                <button class="btn btn-danger" id="emptyRecycleBinBtn">Ê∏ÖÁ©∫ÂõûÊî∂Á´ô</button>
            </div>
        </div>
    </div>
    
    <!-- Âä†ÂØÜÊ®°ÊÄÅÊ°Ü -->
    <div class="encryption-modal" id="encryptionModal">
        <div class="modal-content">
            <h3 class="modal-title">ËÆæÁΩÆÊñá‰ª∂ÂØÜÁ†Å</h3>
            <input type="password" class="password-input" id="zipPassword" placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂ÂØÜÁ†Å" value="">
            <div class="password-hint">
                ÊèêÁ§∫ÔºöÈªòËÆ§ÂØÜÁ†Å‰∏∫‰ªäÊó•Êó•ÊúüÔºàÊúàÊó•Âõõ‰ΩçÊï∞Ôºå‰æãÂ¶ÇÔºö0619Ôºâ
            </div>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="hideEncryptionModal()">ÂèñÊ∂à</button>
                <button class="btn btn-success" onclick="downloadAsText()">Á°ÆËÆ§Âπ∂‰∏ãËΩΩ</button>
            </div>
        </div>
    </div>
    
    <!-- Â™í‰ΩìÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
    <div class="media-preview-modal" id="mediaPreviewModal">
        <div class="preview-content">
            <div class="close-preview" onclick="closeMediaPreview()">√ó</div>
            <div id="previewContainer"></div>
        </div>
    </div>
    
    <!-- Áõ∏Êú∫ËæìÂÖ• -->
    <input type="file" id="cameraInput" accept="image/*" capture="camera" multiple>
    
    <!-- ÂΩïÂÉèËæìÂÖ• -->
    <input type="file" id="videoInput" accept="video/*" capture="camcorder" multiple>
    
    <!-- ÊèêÁ§∫‰ø°ÊÅØ -->
    <div class="toast" id="toast">Êìç‰ΩúÊàêÂäü!</div>
    
    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ
        const appState = {
            currentSystem: 'case', // 'case' Êàñ 'field'
            case: {
                currentStep: 1,
                selectedCaseId: null,
                editingCaseId: null,
                nextCaseId: 100
            },
            field: {
                currentStep: 1,
                witnessCount: 1,
                media: {
                    sceneMedia: [],
                    reporterMedia: [],
                    victimMedia: [],
                    suspectMedia: [],
                    witness1Media: []
                },
                caseTimestamp: new Date().toISOString().replace(/[:.]/g, '-')
            },
            environment: {
                xlsxLoaded: false,
                xlsxVersion: null,
                functionsAvailable: []
            }
        };
        
        // ÈªòËÆ§Ë≠¶ÊÉÖÁ±ªÂûãÊï∞ÊçÆ
        let caseTypes = [];
        
        // ÈªòËÆ§Ê≥ïÂæãËß£ÈáäÊï∞ÊçÆÔºàÂåÖÂê´Ê≥®ÊÑè‰∫ãÈ°πÔºâ
        let legalExplanations = {};
        
        // ÂõûÊî∂Á´ôÊï∞ÊçÆ
        let recycleBin = {
            caseTypes: [],      // Âà†Èô§ÁöÑË≠¶ÊÉÖÁ±ªÂûã
            legalExplanations: [] // Âà†Èô§ÁöÑÊ≥ïÂæãËß£Èáä
        };
        
        // Â™í‰ΩìÊñá‰ª∂‰∏äÈôê
        const MEDIA_LIMIT = 99;
        
        // ÂàùÂßãÂåñÂáΩÊï∞
        function init() {
            // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÊï∞ÊçÆ
            loadFromLocalStorage();
            
            // Ê£ÄÊü•ÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅ
            checkEnvironmentStatus();
            
            // ÂàùÂßãÂåñË≠¶ÊÉÖÂ§ÑÁΩÆÁ≥ªÁªü
            initCaseSystem();
            
            // ÂàùÂßãÂåñÁé∞Âú∫ÁôªËÆ∞Á≥ªÁªü
            initFieldSystem();
            
            // ÁªëÂÆö‰∫ã‰ª∂
            bindEvents();
            
            // ÊòæÁ§∫ÂàùÂßãÂåñÂÆåÊàêÊèêÁ§∫
            setTimeout(() => {
                showToast('Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàêÔºåÊ¨¢Ëøé‰ΩøÁî®ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÊåáÊå•Â∑•‰ΩúÁ≥ªÁªü V5.0');
            }, 1000);
        }
        
        // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÊï∞ÊçÆ
        function loadFromLocalStorage() {
            // Âä†ËΩΩË≠¶ÊÉÖÁ±ªÂûã
            const savedCaseTypes = localStorage.getItem('caseTypes');
            if (savedCaseTypes) {
                caseTypes = JSON.parse(savedCaseTypes);
                // ÊâæÂà∞ÊúÄÂ§ßID
                let maxId = 0;
                caseTypes.forEach(caseType => {
                    if (caseType.id > maxId) maxId = caseType.id;
                });
                appState.case.nextCaseId = maxId + 1;
            }
            
            // Âä†ËΩΩÊ≥ïÂæãËß£ÈáäÔºàÂåÖÂê´Ê≥®ÊÑè‰∫ãÈ°πÔºâ
            const savedLegalExplanations = localStorage.getItem('legalExplanations');
            if (savedLegalExplanations) {
                legalExplanations = JSON.parse(savedLegalExplanations);
            }
            
            // Âä†ËΩΩÂõûÊî∂Á´ôÊï∞ÊçÆ
            const savedRecycleBin = localStorage.getItem('recycleBin');
            if (savedRecycleBin) {
                recycleBin = JSON.parse(savedRecycleBin);
            }
            
            // Âä†ËΩΩÁé∞Âú∫ÁôªËÆ∞Êï∞ÊçÆ
            const savedFieldData = localStorage.getItem('fieldData');
            if (savedFieldData) {
                const fieldData = JSON.parse(savedFieldData);
                // Êõ¥Êñ∞Áé∞Âú∫ÁôªËÆ∞Áä∂ÊÄÅ
                if (fieldData.media) {
                    appState.field.media = fieldData.media;
                }
                if (fieldData.witnessCount) {
                    appState.field.witnessCount = fieldData.witnessCount;
                }
            }
            
            // Âä†ËΩΩÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅ
            const savedEnvState = localStorage.getItem('envState');
            if (savedEnvState) {
                const envState = JSON.parse(savedEnvState);
                if (envState.xlsxLoaded) {
                    appState.environment.xlsxLoaded = envState.xlsxLoaded;
                    appState.environment.xlsxVersion = envState.xlsxVersion;
                    appState.environment.functionsAvailable = envState.functionsAvailable;
                }
            }
        }
        
        // ‰øùÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
        function saveToLocalStorage() {
            localStorage.setItem('caseTypes', JSON.stringify(caseTypes));
            localStorage.setItem('legalExplanations', JSON.stringify(legalExplanations));
            localStorage.setItem('recycleBin', JSON.stringify(recycleBin));
            
            // ‰øùÂ≠òÁé∞Âú∫ÁôªËÆ∞Êï∞ÊçÆ
            const fieldData = {
                media: appState.field.media,
                witnessCount: appState.field.witnessCount
            };
            localStorage.setItem('fieldData', JSON.stringify(fieldData));
            
            // ‰øùÂ≠òÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅ
            localStorage.setItem('envState', JSON.stringify(appState.environment));
        }
        
        // Ê£ÄÊü•ÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅ
        function checkEnvironmentStatus() {
            const envStatus = document.getElementById('envStatus');
            const envLibStatus = document.getElementById('envLibStatus');
            
            if (appState.environment.xlsxLoaded) {
                envStatus.className = 'env-status success';
                envStatus.innerHTML = `<span class="icon">‚úì</span> ÂΩìÂâçÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅÔºöÂ∑≤Âä†ËΩΩ (${appState.environment.xlsxVersion || 'Êú™Áü•ÁâàÊú¨'})`;
                envLibStatus.textContent = `Â∑≤Âä†ËΩΩ (${appState.environment.xlsxVersion || 'Êú™Áü•ÁâàÊú¨'})`;
            } else {
                envStatus.className = 'env-status warning';
                envStatus.innerHTML = `<span class="icon">‚ö†Ô∏è</span> ÂΩìÂâçÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅÔºöÊú™Âä†ËΩΩ`;
                envLibStatus.textContent = 'Êú™Âä†ËΩΩ';
            }
        }
        
        // ÂàùÂßãÂåñË≠¶ÊÉÖÂ§ÑÁΩÆÁ≥ªÁªü
        function initCaseSystem() {
            // Ê∏≤ÊüìË≠¶ÊÉÖÁ±ªÂûã
            renderCaseTypes();
            setupSearch();
            
            // ÂàùÂßãÂåñÊ≠•È™§ÊåáÁ§∫Âô®
            updateStepIndicator('case');
        }
        
        // ÂàùÂßãÂåñÁé∞Âú∫ÁôªËÆ∞Á≥ªÁªü
        function initFieldSystem() {
            initializeMediaInputs();
            
            // ÂàùÂßãÂåñÊ≠•È™§ÊåáÁ§∫Âô®
            updateStepIndicator('field');
            
            // ÂàùÂßãÂåñÂ™í‰ΩìËÆ°Êï∞Âô®
            updateMediaCounter('sceneMedia');
            updateMediaCounter('reporterMedia');
            updateMediaCounter('victimMedia');
            updateMediaCounter('suspectMedia');
            updateMediaCounter('witness1Media');
            
            // Ê∏≤ÊüìÁé∞ÊúâËßÅËØÅ‰∫∫
            renderWitnesses();
        }
        
        // Ê∏≤ÊüìËßÅËØÅ‰∫∫
        function renderWitnesses() {
            for (let i = 2; i <= appState.field.witnessCount; i++) {
                addWitnessToDOM(i);
            }
            document.getElementById('witnessCount').textContent = `ÂΩìÂâç${appState.field.witnessCount}‰ΩçËßÅËØÅ‰∫∫`;
        }
        
        // ÁªëÂÆö‰∫ã‰ª∂
        function bindEvents() {
            // ÂØºÂÖ•ÂØºÂá∫ÊåâÈíÆ
            document.getElementById('importBtn').addEventListener('click', showImportModal);
            document.getElementById('exportBtn').addEventListener('click', exportDataToExcel);
            
            // ÂõûÊî∂Á´ôÊåâÈíÆ
            document.getElementById('recycleBinBtn').addEventListener('click', showRecycleBinModal);
            
            // Ê∑ªÂä†Ë≠¶ÊÉÖÊåâÈíÆ
            document.getElementById('saveCaseBtn').addEventListener('click', saveCase);
            
            // Âà†Èô§Ë≠¶ÊÉÖÊåâÈíÆ
            document.getElementById('deleteCaseBtn').addEventListener('click', deleteCase);
            
            // ‰øùÂ≠òÊ≥ïÂæãËß£ÈáäÊåâÈíÆÔºàÂåÖÂê´Ê≥®ÊÑè‰∫ãÈ°πÔºâ
            document.getElementById('saveLegalBtn').addEventListener('click', saveLegalExplanation);
            
            // ÂØºÂÖ•Êï∞ÊçÆÊåâÈíÆ
            document.getElementById('importDataBtn').addEventListener('click', importDataFromExcel);
            
            // Ê∏ÖÁ©∫ÂõûÊî∂Á´ôÊåâÈíÆ
            document.getElementById('emptyRecycleBinBtn').addEventListener('click', emptyRecycleBin);
            
            // ÁéØÂ¢ÉÂ∫ìÊñá‰ª∂ÈÄâÊã©
            document.getElementById('importEnvFileInput').addEventListener('change', handleEnvFileSelect);
        }
        
        // ÂàáÊç¢Á≥ªÁªü
        function switchSystem(system) {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.system-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.system-btn[onclick*="${system}"]`).classList.add('active');
            
            // Êõ¥Êñ∞ÂÜÖÂÆπÊòæÁ§∫
            document.querySelectorAll('.system-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${system}System`).classList.add('active');
            
            appState.currentSystem = system;
        }
        
        // Ë≠¶ÊÉÖÂ§ÑÁΩÆÁ≥ªÁªüÊ≠•È™§ÁÆ°ÁêÜ
        function goToStep(step, system) {
            const sys = appState[system];
            
            // È™åËØÅÊòØÂê¶ÂèØ‰ª•Ë∑≥ËΩ¨Âà∞ËØ•Ê≠•È™§
            if (system === 'case' && step === 2 && !sys.selectedCaseId) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë≠¶ÊÉÖÁ±ªÂûã');
                return;
            }
            
            // Â¶ÇÊûúË∑≥ËΩ¨Âà∞Á¨¨2Ê≠•ÔºàÊ≥ïÂæãËß£ÈáäÔºâÔºåÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫
            if (system === 'case' && step === 2) {
                loadLegalExplanation();
            }
            
            // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÊ≠•È™§
            const systemContent = document.getElementById(`${system}System`);
            systemContent.querySelectorAll('.step-content').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`${system}Step${step}`).classList.add('active');
            
            // Êõ¥Êñ∞Ê≠•È™§ÊåáÁ§∫Âô®
            updateStepIndicator(system, step);
            
            sys.currentStep = step;
        }
        
        // Êõ¥Êñ∞Ê≠•È™§ÊåáÁ§∫Âô®
        function updateStepIndicator(system, step = appState[system].currentStep) {
            const indicator = document.querySelector(`#${system}System .step-indicator`);
            if (indicator) {
                indicator.querySelectorAll('.step').forEach((el, index) => {
                    if (index + 1 === step) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });
            }
        }
        
        function nextStep(current, system) {
            goToStep(current + 1, system);
        }
        
        function prevStep(current, system) {
            goToStep(current - 1, system);
        }
        
        // Ë≠¶ÊÉÖÁ±ªÂûãÁõ∏ÂÖ≥ÂáΩÊï∞
        function renderCaseTypes(filterText = '') {
            const container = document.getElementById('caseTypesScroll');
            const searchInfo = document.getElementById('searchResultsInfo');
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            container.innerHTML = '';
            
            let filteredCases = caseTypes;
            
            // Â¶ÇÊûúÊúâÊêúÁ¥¢ÊñáÊú¨ÔºåËøõË°åËøáÊª§
            if (filterText.trim()) {
                const searchWords = filterText.trim().toLowerCase().split('');
                
                // ÂÆΩÊùæÂåπÈÖçÔºöÂè™Ë¶ÅÊúâ‰∏Ä‰∏™Â≠óÂåπÈÖçÂ∞±ÊòæÁ§∫
                filteredCases = caseTypes.filter(caseType => {
                    const caseName = caseType.name.toLowerCase();
                    const keywords = caseType.keywords ? caseType.keywords.join(' ').toLowerCase() : '';
                    const searchText = caseName + ' ' + keywords;
                    
                    // Ê£ÄÊü•ÊêúÁ¥¢ÊñáÊú¨‰∏≠ÁöÑÊØè‰∏™Â≠óÊòØÂê¶Âá∫Áé∞Âú®Ë≠¶ÊÉÖÂêçÁß∞ÊàñÂÖ≥ÈîÆËØç‰∏≠
                    return searchWords.some(word => 
                        word && searchText.includes(word)
                    );
                });
                
                // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú‰ø°ÊÅØ
                if (filteredCases.length === 0) {
                    searchInfo.innerHTML = `Êú™ÊâæÂà∞ÂåπÈÖç"${filterText}"ÁöÑË≠¶ÊÉÖÁ±ªÂûãÔºåÊòæÁ§∫ÂÖ®ÈÉ®`;
                    searchInfo.style.display = 'block';
                    filteredCases = caseTypes; // Ê≤°ÊúâÁªìÊûúÊó∂ÊòæÁ§∫ÂÖ®ÈÉ®
                } else {
                    searchInfo.innerHTML = `ÊâæÂà∞${filteredCases.length}‰∏™ÂåπÈÖç"${filterText}"ÁöÑË≠¶ÊÉÖÁ±ªÂûã`;
                    searchInfo.style.display = 'block';
                }
                
                // Â±ïÂºÄÂàóË°®‰ª•‰æøÊü•ÁúãÊêúÁ¥¢ÁªìÊûú
                expandCaseList();
            } else {
                searchInfo.style.display = 'none';
            }
            
            // Ê∏≤ÊüìË≠¶ÊÉÖÁ±ªÂûã
            filteredCases.forEach(caseType => {
                const caseBtn = document.createElement('div');
                caseBtn.className = 'case-btn';
                caseBtn.setAttribute('data-id', caseType.id);
                caseBtn.setAttribute('data-name', caseType.name);
                
                // È´ò‰∫ÆÂåπÈÖçÁöÑÊñáÊú¨
                let displayName = caseType.name;
                if (filterText.trim()) {
                    const searchWords = filterText.trim().toLowerCase().split('');
                    searchWords.forEach(word => {
                        if (word) {
                            const regex = new RegExp(`(${word})`, 'gi');
                            displayName = displayName.replace(regex, '<span class="highlight">$1</span>');
                        }
                    });
                }
                
                caseBtn.innerHTML = `
                    <div class="case-icon">${caseType.icon}</div>
                    <div class="case-name">${displayName}</div>
                    <button class="case-actions-btn" onclick="event.stopPropagation(); editCase(${caseType.id})">
                        <span class="icon">‚ãØ</span>
                    </button>
                `;
                
                caseBtn.onclick = function() {
                    selectCaseType(caseType.id);
                };
                
                // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØËøô‰∏™Á±ªÂûãÔºåÊ∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
                if (appState.case.selectedCaseId === caseType.id) {
                    caseBtn.classList.add('selected');
                }
                
                container.appendChild(caseBtn);
            });
            
            // Ê∑ªÂä†"Ê∑ªÂä†Ë≠¶ÊÉÖÁ±ªÂûã"ÊåâÈíÆ
            const addCaseBtn = document.createElement('div');
            addCaseBtn.className = 'add-case-btn';
            addCaseBtn.innerHTML = `
                <div class="add-icon">+</div>
                <div>Ê∑ªÂä†Ë≠¶ÊÉÖÁ±ªÂûã</div>
            `;
            addCaseBtn.onclick = function() {
                showAddCaseModal();
            };
            container.appendChild(addCaseBtn);
            
            // Êõ¥Êñ∞ÊåáÁ§∫Âô®ÊñáÊú¨
            updateIndicatorText();
        }
        
        function setupSearch() {
            const searchBox = document.getElementById('caseSearch');
            
            // ËæìÂÖ•‰∫ã‰ª∂
            searchBox.addEventListener('input', function(e) {
                const searchText = e.target.value;
                renderCaseTypes(searchText);
            });
            
            // Ê∏ÖÈô§ÊåâÈíÆ
            searchBox.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    searchBox.value = '';
                    renderCaseTypes('');
                }
            });
        }
        
        function selectCaseType(id) {
            appState.case.selectedCaseId = id;
            
            // ÁßªÈô§ÊâÄÊúâcase-btnÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.case-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // ‰∏∫ÂΩìÂâçÁÇπÂáªÁöÑcase-btnÊ∑ªÂä†ÈÄâ‰∏≠Áä∂ÊÄÅ
            const selectedBtn = document.querySelector(`.case-btn[data-id="${id}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // Ê∏ÖÈô§ÊêúÁ¥¢Ê°Ü
            document.getElementById('caseSearch').value = '';
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            const selectedCase = caseTypes.find(c => c.id === id);
            if (selectedCase) {
                showToast(`Â∑≤ÈÄâÊã©Ôºö${selectedCase.name}`);
            }
        }
        
        function toggleExpandCases() {
            const scrollContainer = document.getElementById('caseTypesScroll');
            const indicator = document.getElementById('scrollIndicator');
            const indicatorText = document.getElementById('indicatorText');
            
            if (scrollContainer.classList.contains('collapsed')) {
                // Â±ïÂºÄ
                scrollContainer.classList.remove('collapsed');
                scrollContainer.classList.add('expanded');
                indicator.classList.add('expanded');
                indicatorText.textContent = 'Êî∂Ëµ∑ÂàóË°®';
            } else {
                // Êî∂Ëµ∑
                scrollContainer.classList.remove('expanded');
                scrollContainer.classList.add('collapsed');
                indicator.classList.remove('expanded');
                indicatorText.textContent = 'Â±ïÂºÄÊõ¥Â§ö';
                
                // ÊªöÂä®Âà∞È°∂ÈÉ®
                scrollContainer.scrollTop = 0;
            }
        }
        
        function expandCaseList() {
            const scrollContainer = document.getElementById('caseTypesScroll');
            const indicator = document.getElementById('scrollIndicator');
            const indicatorText = document.getElementById('indicatorText');
            
            scrollContainer.classList.remove('collapsed');
            scrollContainer.classList.add('expanded');
            indicator.classList.add('expanded');
            indicatorText.textContent = 'Êî∂Ëµ∑ÂàóË°®';
        }
        
        function updateIndicatorText() {
            const totalCases = caseTypes.length;
            const indicatorText = document.getElementById('indicatorText');
            indicatorText.textContent = `Â±ïÂºÄÊõ¥Â§ö (${totalCases}Áßç)`;
        }
        
        // Ê≥ïÂæãËß£ÈáäÁõ∏ÂÖ≥ÂáΩÊï∞
        function loadLegalExplanation() {
            const selectedCase = caseTypes.find(c => c.id === appState.case.selectedCaseId);
            if (!selectedCase) return;
            
            const legalData = legalExplanations[selectedCase.id];
            
            // Êõ¥Êñ∞Ê≥ïÂæãÂÜÖÂÆπ
            if (legalData) {
                document.getElementById('lawText').innerHTML = legalData.law || '<p>ÊöÇÊó†Áõ∏ÂÖ≥Ê≥ïÂæãÊ≥ïËßÑ‰ø°ÊÅØ„ÄÇ</p>';
                document.getElementById('interpretationText').innerHTML = legalData.interpretation || '<p>ÊöÇÊó†Áõ∏ÂÖ≥Âè∏Ê≥ïËß£Èáä‰ø°ÊÅØ„ÄÇ</p>';
                document.getElementById('noticeText').innerHTML = legalData.notice || '<p>ÊöÇÊó†Ê≥®ÊÑè‰∫ãÈ°π‰ø°ÊÅØ„ÄÇ</p>';
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÊ≥ïÂæãËß£ÈáäÔºåÊòæÁ§∫ÈªòËÆ§ÂÜÖÂÆπ
                document.getElementById('lawText').innerHTML = '<p>ÊöÇÊó†Áõ∏ÂÖ≥Ê≥ïÂæãÊ≥ïËßÑ‰ø°ÊÅØ„ÄÇ</p>';
                document.getElementById('interpretationText').innerHTML = '<p>ÊöÇÊó†Áõ∏ÂÖ≥Âè∏Ê≥ïËß£Èáä‰ø°ÊÅØ„ÄÇ</p>';
                document.getElementById('noticeText').innerHTML = '<p>ÊöÇÊó†Ê≥®ÊÑè‰∫ãÈ°π‰ø°ÊÅØ„ÄÇ</p>';
            }
            
            // ÈáçÁΩÆÂà∞Ê≥ïÂæãÊ≥ïËßÑÊ†áÁ≠æ
            switchLegalTab('law');
            
            // ÊòæÁ§∫Ë≠¶ÊÉÖÁ±ªÂûãÂêçÁß∞
            document.querySelector('#caseStep2 h2').innerHTML = `<span class="icon">‚öñÔ∏è</span> Ê≥ïÂæãËß£Èáä - ${selectedCase.name}`;
        }
        
        function switchLegalTab(tabName) {
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
            document.querySelectorAll('.legal-tab').forEach(tab => {
                tab.classList.remove('active');
                // Â¶ÇÊûúÊòØÊ≥®ÊÑè‰∫ãÈ°πÊ†áÁ≠æÔºåÁßªÈô§notice-tabÁöÑactiveÊ†∑Âºè
                if (tab.classList.contains('notice-tab')) {
                    tab.classList.remove('notice-tab-active');
                }
            });
            
            // ÁßªÈô§ÊâÄÊúâÂÜÖÂÆπÁöÑactiveÁ±ª
            document.querySelectorAll('.legal-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
            const selectedTab = document.querySelector(`.legal-tab[onclick*="${tabName}"]`);
            selectedTab.classList.add('active');
            
            // Â¶ÇÊûúÊòØÊ≥®ÊÑè‰∫ãÈ°πÊ†áÁ≠æÔºåÊ∑ªÂä†ÁâπÊÆäÊ†∑Âºè
            if (tabName === 'notice') {
                selectedTab.classList.add('notice-tab-active');
            }
            
            // ÊòæÁ§∫ÂØπÂ∫îÁöÑÂÜÖÂÆπ
            document.getElementById(`${tabName}Content`).classList.add('active');
        }
        
        // Áé∞Âú∫ÁôªËÆ∞Á≥ªÁªüÁõ∏ÂÖ≥ÂáΩÊï∞
        function initializeMediaInputs() {
            // Áõ∏Êú∫ËæìÂÖ•
            const cameraInput = document.getElementById('cameraInput');
            cameraInput.onchange = function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    const files = Array.from(e.target.files);
                    const targetId = cameraInput.getAttribute('data-target');
                    
                    if (targetId) {
                        processMediaFiles(files, targetId, 'image');
                    }
                }
            };
            
            // ËßÜÈ¢ëËæìÂÖ•
            const videoInput = document.getElementById('videoInput');
            videoInput.onchange = function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    const files = Array.from(e.target.files);
                    const targetId = videoInput.getAttribute('data-target');
                    
                    if (targetId) {
                        processMediaFiles(files, targetId, 'video');
                    }
                }
            };
        }
        
        function openCamera(targetId) {
            if (appState.field.media[targetId] && appState.field.media[targetId].length >= MEDIA_LIMIT) {
                showToast(`Â∑≤ËææÂà∞ÊúÄÂ§ßÂ™í‰ΩìÊï∞Èáè(${MEDIA_LIMIT})`);
                return;
            }
            
            const cameraInput = document.getElementById('cameraInput');
            cameraInput.setAttribute('data-target', targetId);
            cameraInput.click();
        }
        
        function openVideoRecorder(targetId) {
            if (appState.field.media[targetId] && appState.field.media[targetId].length >= MEDIA_LIMIT) {
                showToast(`Â∑≤ËææÂà∞ÊúÄÂ§ßÂ™í‰ΩìÊï∞Èáè(${MEDIA_LIMIT})`);
                return;
            }
            
            const videoInput = document.getElementById('videoInput');
            videoInput.setAttribute('data-target', targetId);
            videoInput.click();
        }
        
        function createVideoThumbnail(videoFile, callback) {
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            video.src = URL.createObjectURL(videoFile);
            video.muted = true;
            video.playsInline = true;
            
            video.onloadedmetadata = function() {
                canvas.width = 100;
                canvas.height = 100;
                
                video.currentTime = 0.1;
                
                video.onseeked = function() {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const thumbnail = canvas.toDataURL('image/jpeg');
                    callback(thumbnail);
                    URL.revokeObjectURL(video.src);
                };
            };
            
            video.load();
        }
        
        function processMediaFiles(files, targetId, type) {
            if (!appState.field.media[targetId]) {
                appState.field.media[targetId] = [];
            }
            
            const remaining = MEDIA_LIMIT - appState.field.media[targetId].length;
            if (files.length > remaining) {
                showToast(`Âè™ËÉΩÊ∑ªÂä†${remaining}‰∏™Â™í‰ΩìÊñá‰ª∂`);
                files.splice(remaining);
            }
            
            let processedCount = 0;
            const totalFiles = files.length;
            
            files.forEach(file => {
                if (appState.field.media[targetId].length >= MEDIA_LIMIT) return;
                
                if (type === 'image') {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        addMedia(targetId, {
                            type: 'image',
                            data: event.target.result,
                            thumbnail: event.target.result,
                            name: `ÁÖßÁâá_${new Date().getTime()}_${processedCount + 1}.jpg`,
                            file: file,
                            timestamp: new Date().toISOString()
                        });
                        
                        processedCount++;
                        if (processedCount === totalFiles) {
                            showToast(`ÊàêÂäüÊ∑ªÂä†${totalFiles}Âº†ÁÖßÁâá`);
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    // ËßÜÈ¢ëÊñá‰ª∂
                    createVideoThumbnail(file, function(thumbnail) {
                        const videoUrl = URL.createObjectURL(file);
                        addMedia(targetId, {
                            type: 'video',
                            data: videoUrl,
                            thumbnail: thumbnail,
                            name: file.name,
                            file: file,
                            timestamp: new Date().toISOString(),
                            duration: '00:00'
                        });
                        
                        processedCount++;
                        if (processedCount === totalFiles) {
                            showToast(`ÊàêÂäüÊ∑ªÂä†${totalFiles}ÊÆµËßÜÈ¢ë`);
                        }
                    });
                }
            });
            
            // ‰øùÂ≠òÊï∞ÊçÆ
            saveToLocalStorage();
        }
        
        function addMedia(targetId, media) {
            const mediaId = `media_${targetId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const mediaWithId = {
                ...media,
                id: mediaId
            };
            
            if (!appState.field.media[targetId]) {
                appState.field.media[targetId] = [];
            }
            
            appState.field.media[targetId].push(mediaWithId);
            
            const container = document.getElementById(targetId);
            if (!container) return;
            
            // ÁßªÈô§Á©∫Ê∂àÊÅØ
            const emptyMessage = container.querySelector('.empty-grid-message');
            if (emptyMessage) {
                container.removeChild(emptyMessage);
            }
            
            // ÂàõÂª∫Â™í‰ΩìÈ°π
            const mediaItem = document.createElement('div');
            mediaItem.className = 'media-item';
            mediaItem.setAttribute('data-id', mediaId);
            
            if (media.type === 'image') {
                mediaItem.innerHTML = `
                    <img src="${media.thumbnail}" alt="ÁÖßÁâá" loading="lazy">
                    <div class="media-type-badge">ÂõæÁâá</div>
                    <div class="delete" onclick="deleteMedia('${targetId}', '${mediaId}')">√ó</div>
                `;
            } else {
                mediaItem.innerHTML = `
                    <img src="${media.thumbnail}" class="video-thumbnail" alt="ËßÜÈ¢ëÁº©Áï•Âõæ" loading="lazy">
                    <div class="video-icon">‚ñ∂</div>
                    <div class="media-type-badge">ËßÜÈ¢ë</div>
                    <div class="delete" onclick="deleteMedia('${targetId}', '${mediaId}')">√ó</div>
                `;
            }
            
            // ÁÇπÂáªÈ¢ÑËßà
            mediaItem.addEventListener('click', function(e) {
                if (!e.target.classList.contains('delete') && !e.target.classList.contains('media-type-badge')) {
                    previewMedia(mediaWithId);
                }
            });
            
            container.appendChild(mediaItem);
            
            // Êõ¥Êñ∞ËÆ°Êï∞Âô®
            updateMediaCounter(targetId);
        }
        
        function previewMedia(media) {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';
            
            if (media.type === 'image') {
                const img = document.createElement('img');
                img.src = media.data;
                img.alt = "ÂõæÁâáÈ¢ÑËßà";
                previewContainer.appendChild(img);
            } else {
                const video = document.createElement('video');
                video.src = media.data;
                video.controls = true;
                video.autoplay = true;
                video.style.width = "100%";
                previewContainer.appendChild(video);
            }
            
            const modal = document.getElementById('mediaPreviewModal');
            modal.classList.add('show');
        }
        
        function closeMediaPreview() {
            const modal = document.getElementById('mediaPreviewModal');
            modal.classList.remove('show');
            
            // ÈáäÊîæËßÜÈ¢ëURL
            const video = document.querySelector('#previewContainer video');
            if (video) {
                video.pause();
            }
        }
        
        function deleteMedia(targetId, mediaId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â™í‰ΩìÊñá‰ª∂ÂêóÔºü')) {
                return;
            }
            
            const container = document.getElementById(targetId);
            if (!container) return;
            
            // ‰ªéÁä∂ÊÄÅ‰∏≠ÁßªÈô§
            const index = appState.field.media[targetId].findIndex(m => m.id === mediaId);
            if (index !== -1) {
                // ÈáäÊîæËßÜÈ¢ëURL
                if (appState.field.media[targetId][index].type === 'video') {
                    URL.revokeObjectURL(appState.field.media[targetId][index].data);
                }
                
                appState.field.media[targetId].splice(index, 1);
            }
            
            // ‰ªéDOM‰∏≠ÁßªÈô§
            const mediaItem = container.querySelector(`.media-item[data-id="${mediaId}"]`);
            if (mediaItem) {
                container.removeChild(mediaItem);
            }
            
            // Â¶ÇÊûúÊ≤°ÊúâÂ™í‰Ωì‰∫ÜÔºåÊòæÁ§∫Á©∫Ê∂àÊÅØ
            if (appState.field.media[targetId].length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-grid-message';
                emptyMessage.textContent = 'ÊöÇÊó†Â™í‰ΩìÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†';
                container.appendChild(emptyMessage);
            }
            
            // Êõ¥Êñ∞ËÆ°Êï∞Âô®
            updateMediaCounter(targetId);
            
            // ‰øùÂ≠òÊï∞ÊçÆ
            saveToLocalStorage();
            
            showToast('Â™í‰ΩìÂ∑≤Âà†Èô§');
        }
        
        function updateMediaCounter(targetId) {
            const count = appState.field.media[targetId] ? appState.field.media[targetId].length : 0;
            const counterElement = document.getElementById(`${targetId}Counter`);
            
            if (counterElement) {
                counterElement.textContent = `${count}/${MEDIA_LIMIT}`;
                
                if (count >= MEDIA_LIMIT - 10 && count < MEDIA_LIMIT) {
                    counterElement.classList.remove('media-counter');
                    counterElement.classList.add('media-counter-warning');
                } else if (count >= MEDIA_LIMIT) {
                    counterElement.textContent = `Â∑≤Ëææ‰∏äÈôê (${MEDIA_LIMIT})`;
                    counterElement.classList.remove('media-counter');
                    counterElement.classList.add('media-counter-warning');
                } else {
                    counterElement.classList.remove('media-counter-warning');
                    counterElement.classList.add('media-counter');
                }
            }
        }
        
        function addWitness() {
            appState.field.witnessCount++;
            const witnessId = appState.field.witnessCount;
            
            addWitnessToDOM(witnessId);
            
            document.getElementById('witnessCount').textContent = `ÂΩìÂâç${witnessId}‰ΩçËßÅËØÅ‰∫∫`;
            
            // ‰øùÂ≠òÊï∞ÊçÆ
            saveToLocalStorage();
        }
        
        function addWitnessToDOM(witnessId) {
            const newWitness = document.createElement('div');
            newWitness.className = 'module witness-module';
            newWitness.innerHTML = `
                <div class="media-header">
                    <div class="module-title">
                        <span class="icon">üë§</span> ËßÅËØÅ‰∫∫ ${witnessId}
                    </div>
                    <div id="witness${witnessId}Counter" class="media-counter">0/99</div>
                </div>
                <textarea class="witness-info" placeholder="ÂßìÂêçÔºö&#10;ËÅîÁ≥ªÊñπÂºèÔºö&#10;Ë∫´‰ªΩËØÅÂè∑Ôºö&#10;ÂÖ∂‰ªñ‰ø°ÊÅØ..."></textarea>
                <div class="module-title">
                    <span class="icon">üì∑</span> ËßÅËØÅ‰∫∫ÁÖßÁâá/ËßÜÈ¢ë
                </div>
                <div class="media-grid witness-media" id="witness${witnessId}Media">
                    <div class="empty-grid-message">ÊöÇÊó†Â™í‰ΩìÔºåËØ∑ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†</div>
                </div>
                <div class="media-controls">
                    <div class="media-btn" onclick="openCamera('witness${witnessId}Media')">
                        <span class="icon">üì∑</span>
                        <div>ÊãçÁÖß</div>
                    </div>
                    <div class="media-btn" onclick="openVideoRecorder('witness${witnessId}Media')">
                        <span class="icon">üé•</span>
                        <div>ÂΩïÂÉè</div>
                    </div>
                </div>
            `;
            
            document.getElementById('additionalWitnesses').appendChild(newWitness);
            
            // ÂàùÂßãÂåñÊñ∞ËßÅËØÅ‰∫∫ÁöÑÂ™í‰ΩìÊï∞ÁªÑ
            appState.field.media[`witness${witnessId}Media`] = [];
        }
        
        // ÊñáÊú¨ÁºñÁ†ÅËæÖÂä©ÂáΩÊï∞
        function stringToUint8Array(str) {
            const encoder = new TextEncoder();
            return encoder.encode(str);
        }
        
        // ÁîüÊàêZIPÂéãÁº©ÂåÖ
        function generateZipPackage() {
            // ÊòæÁ§∫ÂéãÁº©ËøõÂ∫¶
            const compressionStatus = document.getElementById('compressionStatus');
            const compressionProgressBar = document.getElementById('compressionProgressBar');
            const compressionDetails = document.getElementById('compressionDetails');
            
            compressionStatus.style.display = 'block';
            compressionProgressBar.style.width = '0%';
            compressionDetails.textContent = 'Ê≠£Âú®ÂáÜÂ§áÊñá‰ª∂...';
            
            // ‰ΩøÁî®JSZipÂ∫ìÂàõÂª∫ÂéãÁº©ÂåÖ
            const zip = new JSZip();
            let totalFiles = 0;
            let processedFiles = 0;
            
            // ËÆ°ÁÆóÊÄªÊñá‰ª∂Êï∞
            totalFiles += 1; // Â∑•‰ΩúËÆ∞ÂΩïÊñá‰ª∂
            
            Object.keys(appState.field.media).forEach(key => {
                totalFiles += (appState.field.media[key] || []).length;
            });
            
            // Êõ¥Êñ∞ËøõÂ∫¶
            function updateProgress(fileName) {
                processedFiles++;
                const progress = Math.round((processedFiles / totalFiles) * 100);
                compressionProgressBar.style.width = `${progress}%`;
                compressionDetails.textContent = `Ê≠£Âú®Â§ÑÁêÜ: ${fileName} (${processedFiles}/${totalFiles})`;
            }
            
            // ÁîüÊàêÂ∑•‰ΩúËÆ∞ÂΩïÊñá‰ª∂ÂÜÖÂÆπ
            function generateWorkRecord() {
                const report = [];
                
                report.push(`ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÁé∞Âú∫‰ø°ÊÅØÈááÈõÜÂ∑•‰ΩúÊä•Âëä`);
                report.push(`=====================================`);
                report.push(``);
                report.push(`ËÆ∞ÂΩïÊó∂Èó¥: ${new Date().toLocaleString('zh-CN')}`);
                report.push(`ËÆ∞ÂΩïÊ∞ëË≠¶: ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÊâßÂã§Ë≠¶Âä°Èòü`);
                report.push(``);
                
                // Ë≠¶ÊÉÖ‰ø°ÊÅØ
                const selectedCase = caseTypes.find(c => c.id === appState.case.selectedCaseId);
                if (selectedCase) {
                    report.push(`Ë≠¶ÊÉÖÁ±ªÂûã: ${selectedCase.name}`);
                }
                
                report.push(``);
                report.push(`‰∏Ä„ÄÅÁé∞Âú∫ÊÉÖÂÜµ`);
                report.push(`Áé∞Âú∫ÊèèËø∞: ${document.getElementById('sceneDesc').value || 'Êú™Â°´ÂÜô'}`);
                const sceneImageCount = appState.field.media.sceneMedia.filter(m => m.type === 'image').length;
                const sceneVideoCount = appState.field.media.sceneMedia.filter(m => m.type === 'video').length;
                report.push(`Áé∞Âú∫Â™í‰Ωì: ${sceneImageCount}Âº†ÁÖßÁâá, ${sceneVideoCount}ÊÆµËßÜÈ¢ë`);
                report.push(``);
                
                report.push(`‰∫å„ÄÅÊä•Ë≠¶‰∫∫‰ø°ÊÅØ`);
                report.push(`Êä•Ë≠¶‰∫∫‰ø°ÊÅØ: ${document.getElementById('reporterInfo').value || 'Êú™ÁôªËÆ∞'}`);
                const reporterImageCount = appState.field.media.reporterMedia.filter(m => m.type === 'image').length;
                const reporterVideoCount = appState.field.media.reporterMedia.filter(m => m.type === 'video').length;
                report.push(`Êä•Ë≠¶‰∫∫Â™í‰Ωì: ${reporterImageCount}Âº†ÁÖßÁâá, ${reporterVideoCount}ÊÆµËßÜÈ¢ë`);
                report.push(``);
                
                report.push(`‰∏â„ÄÅË¢´ÂÆ≥‰∫∫‰ø°ÊÅØ`);
                report.push(`Ë¢´ÂÆ≥‰∫∫‰ø°ÊÅØ: ${document.getElementById('victimInfo').value || 'Êú™ÁôªËÆ∞'}`);
                const victimImageCount = appState.field.media.victimMedia.filter(m => m.type === 'image').length;
                const victimVideoCount = appState.field.media.victimMedia.filter(m => m.type === 'video').length;
                report.push(`Ë¢´ÂÆ≥‰∫∫Â™í‰Ωì: ${victimImageCount}Âº†ÁÖßÁâá, ${victimVideoCount}ÊÆµËßÜÈ¢ë`);
                report.push(``);
                
                report.push(`Âõõ„ÄÅÂ´åÁñë‰∫∫‰ø°ÊÅØ`);
                report.push(`Â´åÁñë‰∫∫‰ø°ÊÅØ: ${document.getElementById('suspectInfo').value || 'Êú™ÁôªËÆ∞'}`);
                const suspectImageCount = appState.field.media.suspectMedia.filter(m => m.type === 'image').length;
                const suspectVideoCount = appState.field.media.suspectMedia.filter(m => m.type === 'video').length;
                report.push(`Â´åÁñë‰∫∫Â™í‰Ωì: ${suspectImageCount}Âº†ÁÖßÁâá, ${suspectVideoCount}ÊÆµËßÜÈ¢ë`);
                report.push(``);
                
                report.push(`‰∫î„ÄÅËßÅËØÅ‰∫∫‰ø°ÊÅØ`);
                report.push(`ËßÅËØÅ‰∫∫Êï∞Èáè: ${appState.field.witnessCount}‰∫∫`);
                for (let i = 1; i <= appState.field.witnessCount; i++) {
                    const witnessInfo = document.querySelectorAll('.witness-info')[i-1]?.value;
                    if (witnessInfo) {
                        report.push(`ËßÅËØÅ‰∫∫${i}‰ø°ÊÅØ: ${witnessInfo}`);
                    }
                }
                report.push(``);
                
                report.push(`ÂÖ≠„ÄÅÂ§áÊ≥®`);
                report.push(`Êú¨Êä•Âëä‰∏∫Áé∞Âú∫‰ø°ÊÅØÈááÈõÜËÆ∞ÂΩïÔºåÊâÄÊúâÊï∞ÊçÆÂ∑≤ÊâìÂåÖ‰øùÂ≠ò„ÄÇ`);
                
                return report.join('\n');
            }
            
            // Â§ÑÁêÜÂ™í‰ΩìÊñá‰ª∂Â§π
            async function processMediaFolder(zip, folderPath, mediaArray, prefix) {
                if (!mediaArray || mediaArray.length === 0) return;
                
                for (let i = 0; i < mediaArray.length; i++) {
                    const media = mediaArray[i];
                    const extension = media.type === 'image' ? '.jpg' : '.mp4';
                    const fileName = `${prefix}_${i + 1}${extension}`;
                    
                    if (media.type === 'image') {
                        // Â§ÑÁêÜÂõæÁâá - ‰øÆÂ§çÁºñÁ†ÅÈóÆÈ¢ò
                        try {
                            // Â∞Übase64ËΩ¨Êç¢‰∏∫‰∫åËøõÂà∂Êï∞ÊçÆ
                            const base64Data = media.data;
                            let binaryString;
                            
                            if (base64Data.startsWith('data:')) {
                                // Â¶ÇÊûúÊòØdata URLÔºåÊèêÂèñbase64ÈÉ®ÂàÜ
                                const base64Content = base64Data.split(',')[1];
                                binaryString = atob(base64Content);
                            } else {
                                // Â¶ÇÊûúÊòØÁ∫Øbase64
                                binaryString = atob(base64Data);
                            }
                            
                            // ËΩ¨Êç¢‰∏∫Â≠óËäÇÊï∞ÁªÑ
                            const bytes = new Uint8Array(binaryString.length);
                            for (let j = 0; j < binaryString.length; j++) {
                                bytes[j] = binaryString.charCodeAt(j);
                            }
                            
                            // Ê∑ªÂä†Âà∞zip
                            zip.file(folderPath + fileName, bytes);
                        } catch (error) {
                            console.error(`Â§ÑÁêÜÂõæÁâáÂ§±Ë¥•: ${fileName}`, error);
                            showToast(`Â§ÑÁêÜÂõæÁâáÂ§±Ë¥•: ${error.message}`);
                        }
                    } else {
                        // Â§ÑÁêÜËßÜÈ¢ë
                        try {
                            const response = await fetch(media.data);
                            if (!response.ok) throw new Error(`HTTP ${response.status}`);
                            const blob = await response.blob();
                            zip.file(folderPath + fileName, blob);
                        } catch (error) {
                            console.error(`Â§ÑÁêÜËßÜÈ¢ëÂ§±Ë¥•: ${fileName}`, error);
                            showToast(`Â§ÑÁêÜËßÜÈ¢ëÂ§±Ë¥•: ${error.message}`);
                        }
                    }
                    
                    updateProgress(fileName);
                }
            }
            
            // ÂºÇÊ≠•Â§ÑÁêÜÊâÄÊúâÊñá‰ª∂
            async function processAllFiles() {
                try {
                    // Ê∑ªÂä†Â∑•‰ΩúËÆ∞ÂΩïÊñá‰ª∂
                    const workRecordContent = generateWorkRecord();
                    // ‰ΩøÁî®UTF-8ÁºñÁ†Å
                    zip.file("Â∑•‰ΩúËÆ∞ÂΩï.txt", stringToUint8Array(workRecordContent));
                    updateProgress("Â∑•‰ΩúËÆ∞ÂΩï.txt");
                    
                    // Â§ÑÁêÜÁé∞Âú∫ÊÉÖÂÜµÂ™í‰ΩìÊñá‰ª∂
                    await processMediaFolder(zip, "Áé∞Âú∫ÊÉÖÂÜµ/", appState.field.media.sceneMedia, "Áé∞Âú∫");
                    
                    // Â§ÑÁêÜÊä•Ë≠¶‰∫∫Â™í‰ΩìÊñá‰ª∂
                    await processMediaFolder(zip, "Êä•Ë≠¶‰∫∫/", appState.field.media.reporterMedia, "Êä•Ë≠¶‰∫∫");
                    
                    // Â§ÑÁêÜË¢´ÂÆ≥‰∫∫Â™í‰ΩìÊñá‰ª∂
                    await processMediaFolder(zip, "Ë¢´ÂÆ≥‰∫∫/", appState.field.media.victimMedia, "Ë¢´ÂÆ≥‰∫∫");
                    
                    // Â§ÑÁêÜÂ´åÁñë‰∫∫Â™í‰ΩìÊñá‰ª∂
                    await processMediaFolder(zip, "Â´åÁñë‰∫∫/", appState.field.media.suspectMedia, "Â´åÁñë‰∫∫");
                    
                    // Â§ÑÁêÜËßÅËØÅ‰∫∫Â™í‰ΩìÊñá‰ª∂
                    for (let i = 1; i <= appState.field.witnessCount; i++) {
                        const witnessMedia = appState.field.media[`witness${i}Media`] || [];
                        await processMediaFolder(zip, `ËßÅËØÅ‰∫∫/ËßÅËØÅ‰∫∫${i}/`, witnessMedia, `ËßÅËØÅ‰∫∫${i}`);
                    }
                    
                    // ÁîüÊàêÂéãÁº©ÂåÖ
                    compressionDetails.textContent = "Ê≠£Âú®ÁîüÊàêÂéãÁº©ÂåÖ...";
                    const content = await zip.generateAsync({ type: "blob" });
                    
                    // ‰∏ãËΩΩÊñá‰ª∂
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                    const fileName = `Áé∞Âú∫‰ø°ÊÅØÈááÈõÜ_${timestamp}.zip`;
                    
                    const url = URL.createObjectURL(content);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // ÂÆåÊàêÊèêÁ§∫
                    compressionDetails.textContent = "ÂéãÁº©ÂåÖÁîüÊàêÂÆåÊàêÔºÅ";
                    setTimeout(() => {
                        compressionStatus.style.display = 'none';
                        showToast('Êï∞ÊçÆÂéãÁº©ÂåÖ‰∏ãËΩΩÂÆåÊàêÔºÅ');
                    }, 1000);
                    
                } catch (error) {
                    console.error('ÁîüÊàêÂéãÁº©ÂåÖÂ§±Ë¥•:', error);
                    compressionDetails.textContent = `ÁîüÊàêÂ§±Ë¥•: ${error.message}`;
                    showToast('ÁîüÊàêÂéãÁº©ÂåÖÂ§±Ë¥•: ' + error.message);
                }
            }
            
            // ÂºÄÂßãÂ§ÑÁêÜÊñá‰ª∂
            processAllFiles();
        }
        
        // Ê®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂáΩÊï∞
        function showAddCaseModal() {
            appState.case.editingCaseId = null;
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†Ë≠¶ÊÉÖÁ±ªÂûã';
            document.getElementById('caseNameInput').value = '';
            document.getElementById('caseIconSelect').value = 'üî™';
            document.getElementById('caseKeywordsInput').value = '';
            
            // ÈöêËóèÂà†Èô§ÊåâÈíÆÂå∫Âüü
            document.getElementById('deleteAction').style.display = 'none';
            
            openModal('addCaseModal');
        }
        
        function editCase(id) {
            const caseType = caseTypes.find(c => c.id === id);
            if (!caseType) return;
            
            appState.case.editingCaseId = id;
            document.getElementById('modalTitle').textContent = 'ÁºñËæëË≠¶ÊÉÖÁ±ªÂûã';
            document.getElementById('caseNameInput').value = caseType.name;
            document.getElementById('caseIconSelect').value = caseType.icon;
            document.getElementById('caseKeywordsInput').value = caseType.keywords ? caseType.keywords.join(', ') : '';
            
            // ÊòæÁ§∫Âà†Èô§ÊåâÈíÆÂå∫Âüü
            document.getElementById('deleteAction').style.display = 'block';
            
            openModal('addCaseModal');
        }
        
        function saveCase() {
            const name = document.getElementById('caseNameInput').value.trim();
            const icon = document.getElementById('caseIconSelect').value;
            const keywords = document.getElementById('caseKeywordsInput').value.split(',').map(k => k.trim()).filter(k => k);
            
            if (!name) {
                showToast('ËØ∑ËæìÂÖ•Ë≠¶ÊÉÖÂêçÁß∞');
                return;
            }
            
            if (appState.case.editingCaseId) {
                // ÁºñËæëÁé∞ÊúâË≠¶ÊÉÖÁ±ªÂûã
                const index = caseTypes.findIndex(c => c.id === appState.case.editingCaseId);
                if (index !== -1) {
                    caseTypes[index] = {
                        ...caseTypes[index],
                        name,
                        icon,
                        keywords
                    };
                }
                showToast('Ë≠¶ÊÉÖÁ±ªÂûãÂ∑≤Êõ¥Êñ∞');
            } else {
                // Ê∑ªÂä†Êñ∞Ë≠¶ÊÉÖÁ±ªÂûã
                const newCase = {
                    id: appState.case.nextCaseId++,
                    name,
                    icon,
                    keywords
                };
                caseTypes.push(newCase);
                
                showToast('Ë≠¶ÊÉÖÁ±ªÂûãÂ∑≤Ê∑ªÂä†');
            }
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveToLocalStorage();
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
            renderCaseTypes();
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeModal('addCaseModal');
        }
        
        function deleteCase() {
            if (!appState.case.editingCaseId) return;
            
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë≠¶ÊÉÖÁ±ªÂûãÂêóÔºüÂà†Èô§ÂêéÂ∞ÜÊöÇÊó∂‰øùÂ≠òÂú®ÂõûÊî∂Á´ôÔºåÂèØ‰ª•ÊÅ¢Â§ç„ÄÇ')) {
                // Ëé∑ÂèñË¶ÅÂà†Èô§ÁöÑË≠¶ÊÉÖÁ±ªÂûã
                const index = caseTypes.findIndex(c => c.id === appState.case.editingCaseId);
                if (index === -1) return;
                
                const deletedCase = caseTypes[index];
                
                // Ëé∑ÂèñÁõ∏ÂÖ≥ÁöÑÊ≥ïÂæãËß£Èáä
                const deletedLegalExplanation = legalExplanations[appState.case.editingCaseId];
                
                // ‰øùÂ≠òÂà∞ÂõûÊî∂Á´ô
                const recycleItem = {
                    type: 'caseType',
                    data: deletedCase,
                    relatedLegalExplanation: deletedLegalExplanation,
                    deleteTime: new Date().toLocaleString()
                };
                
                recycleBin.caseTypes.push(recycleItem);
                
                // ‰ªécaseTypesÊï∞ÁªÑ‰∏≠Âà†Èô§
                caseTypes.splice(index, 1);
                
                // ‰ªélegalExplanations‰∏≠Âà†Èô§ÂØπÂ∫îÁöÑÊ≥ïÂæãËß£Èáä
                if (legalExplanations[appState.case.editingCaseId]) {
                    delete legalExplanations[appState.case.editingCaseId];
                }
                
                // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØËøô‰∏™Á±ªÂûãÔºåÊ∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
                if (appState.case.selectedCaseId === appState.case.editingCaseId) {
                    appState.case.selectedCaseId = null;
                }
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                saveToLocalStorage();
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                renderCaseTypes();
                
                showToast('Ë≠¶ÊÉÖÁ±ªÂûãÂ∑≤ÁßªÂà∞ÂõûÊî∂Á´ô');
                closeModal('addCaseModal');
            }
        }
        
        function showEditLegalModal() {
            if (!appState.case.selectedCaseId) {
                showToast('ËØ∑ÂÖàÈÄâÊã©Ë≠¶ÊÉÖÁ±ªÂûã');
                return;
            }
            
            // Êõ¥Êñ∞Ë≠¶ÊÉÖÁ±ªÂûãÈÄâÊã©
            const legalCaseSelect = document.getElementById('legalCaseSelect');
            legalCaseSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ë≠¶ÊÉÖÁ±ªÂûã</option>';
            caseTypes.forEach(caseType => {
                const option = document.createElement('option');
                option.value = caseType.id;
                option.textContent = caseType.name;
                if (caseType.id === appState.case.selectedCaseId) {
                    option.selected = true;
                }
                legalCaseSelect.appendChild(option);
            });
            
            // Âä†ËΩΩÁé∞ÊúâÊ≥ïÂæãËß£ÈáäÔºàÂåÖÊã¨Ê≥®ÊÑè‰∫ãÈ°πÔºâ
            const legalData = legalExplanations[appState.case.selectedCaseId];
            document.getElementById('legalLawInput').value = legalData ? legalData.law || '' : '';
            document.getElementById('legalInterpretationInput').value = legalData ? legalData.interpretation || '' : '';
            document.getElementById('legalNoticeInput').value = legalData ? legalData.notice || '' : '';
            
            openModal('editLegalModal');
        }
        
        function saveLegalExplanation() {
            const caseId = parseInt(document.getElementById('legalCaseSelect').value);
            const law = document.getElementById('legalLawInput').value.trim();
            const interpretation = document.getElementById('legalInterpretationInput').value.trim();
            const notice = document.getElementById('legalNoticeInput').value.trim();
            
            if (!caseId) {
                showToast('ËØ∑ÈÄâÊã©Ë≠¶ÊÉÖÁ±ªÂûã');
                return;
            }
            
            // Â¶ÇÊûúÊúâÊóßÁöÑËß£ÈáäÔºåÂÖà‰øùÂ≠òÂà∞ÂõûÊî∂Á´ô
            if (legalExplanations[caseId]) {
                recycleBin.legalExplanations.push({
                    type: 'legalExplanation',
                    data: {
                        caseId: caseId,
                        explanation: legalExplanations[caseId]
                    },
                    deleteTime: new Date().toLocaleString()
                });
            }
            
            // ‰øùÂ≠òÊ≥ïÂæãËß£ÈáäÔºàÂåÖÊã¨Ê≥®ÊÑè‰∫ãÈ°πÔºâ
            legalExplanations[caseId] = {
                law,
                interpretation,
                notice
            };
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveToLocalStorage();
            
            // ÈáçÊñ∞Âä†ËΩΩÊ≥ïÂæãËß£Èáä
            if (caseId === appState.case.selectedCaseId) {
                loadLegalExplanation();
            }
            
            showToast('Ê≥ïÂæãËß£ÈáäÂ∑≤‰øùÂ≠ò');
            closeModal('editLegalModal');
        }
        
        // ÂØºÂÖ•Áõ∏ÂÖ≥ÂáΩÊï∞
        function showImportModal() {
            // ÈáçÁΩÆÁä∂ÊÄÅ
            document.getElementById('importFileInput').value = '';
            document.getElementById('excelStatus').style.display = 'none';
            document.getElementById('excelStatus').className = 'excel-status';
            
            // Ê£ÄÊü•ÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅ
            checkEnvironmentStatus();
            
            // Êõ¥Êñ∞Á≥ªÁªü‰ø°ÊÅØ
            updateSystemInfo();
            
            openModal('importModal');
        }
        
        function switchImportTab(tabName) {
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
            document.querySelectorAll('.import-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÂÜÖÂÆπÁöÑactiveÁ±ª
            document.querySelectorAll('.import-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÊøÄÊ¥ªÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
            document.querySelector(`.import-tab[onclick*="${tabName}"]`).classList.add('active');
            
            // ÊòæÁ§∫ÂØπÂ∫îÁöÑÂÜÖÂÆπ
            document.getElementById(`import${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
        }
        
        function handleEnvFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.name.endsWith('.js')) {
                showToast('ËØ∑ÈÄâÊã©.jsÊ†ºÂºèÁöÑÁéØÂ¢ÉÂ∫ìÊñá‰ª∂');
                return;
            }
            
            const envStatus = document.getElementById('envStatus');
            envStatus.className = 'env-status info';
            envStatus.innerHTML = `<span class="icon">‚è≥</span> Ê≠£Âú®Âä†ËΩΩÁéØÂ¢ÉÂ∫ìÊñá‰ª∂: ${file.name}...`;
        }
        
        function importEnvironmentLibrary() {
            const fileInput = document.getElementById('importEnvFileInput');
            if (!fileInput.files.length) {
                showToast('ËØ∑ÂÖàÈÄâÊã©ÁéØÂ¢ÉÂ∫ìÊñá‰ª∂');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const envStatus = document.getElementById('envStatus');
                    
                    // ÂàõÂª∫scriptÊ†áÁ≠æÂπ∂ÊâßË°å
                    const scriptContent = e.target.result;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØxlsxÂ∫ì
                    if (scriptContent.includes('XLSX') && scriptContent.includes('SheetJS')) {
                        // ÂàõÂª∫scriptÂÖÉÁ¥†
                        const script = document.createElement('script');
                        script.textContent = scriptContent;
                        document.head.appendChild(script);
                        
                        // Ê£ÄÊü•ÊòØÂê¶Âä†ËΩΩÊàêÂäü
                        setTimeout(() => {
                            if (typeof XLSX !== 'undefined') {
                                appState.environment.xlsxLoaded = true;
                                appState.environment.xlsxVersion = 'SheetJS';
                                appState.environment.functionsAvailable = ['read', 'write', 'utils'];
                                
                                // ‰øùÂ≠òÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅ
                                saveToLocalStorage();
                                
                                // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                                envStatus.className = 'env-status success';
                                envStatus.innerHTML = `<span class="icon">‚úì</span> ÁéØÂ¢ÉÂ∫ìÂä†ËΩΩÊàêÂäü! ÁâàÊú¨: SheetJS`;
                                
                                // Êõ¥Êñ∞Á≥ªÁªü‰ø°ÊÅØ
                                updateSystemInfo();
                                
                                showToast('ExcelÁéØÂ¢ÉÂ∫ìÂä†ËΩΩÊàêÂäüÔºÅ');
                            } else {
                                envStatus.className = 'env-status error';
                                envStatus.innerHTML = `<span class="icon">‚ùå</span> ÁéØÂ¢ÉÂ∫ìÂä†ËΩΩÂ§±Ë¥•: Êú™ÊâæÂà∞XLSXÂØπË±°`;
                                showToast('ÁéØÂ¢ÉÂ∫ìÂä†ËΩΩÂ§±Ë¥•');
                            }
                        }, 100);
                    } else {
                        envStatus.className = 'env-status error';
                        envStatus.innerHTML = `<span class="icon">‚ùå</span> Êó†ÊïàÁöÑÁéØÂ¢ÉÂ∫ìÊñá‰ª∂: ‰∏çÊòØÊúâÊïàÁöÑxlsxÂ∫ì`;
                        showToast('Êó†ÊïàÁöÑÁéØÂ¢ÉÂ∫ìÊñá‰ª∂');
                    }
                } catch (error) {
                    const envStatus = document.getElementById('envStatus');
                    envStatus.className = 'env-status error';
                    envStatus.innerHTML = `<span class="icon">‚ùå</span> ÁéØÂ¢ÉÂ∫ìÂä†ËΩΩÂ§±Ë¥•: ${error.message}`;
                    showToast('ÁéØÂ¢ÉÂ∫ìÂä†ËΩΩÂ§±Ë¥•: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                const envStatus = document.getElementById('envStatus');
                envStatus.className = 'env-status error';
                envStatus.innerHTML = `<span class="icon">‚ùå</span> Êñá‰ª∂ËØªÂèñÂ§±Ë¥•`;
                showToast('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
            };
            
            reader.readAsText(file);
        }
        
        function testExcelFunctions() {
            const envStatus = document.getElementById('envStatus');
            
            if (!appState.environment.xlsxLoaded) {
                envStatus.className = 'env-status error';
                envStatus.innerHTML = `<span class="icon">‚ùå</span> ÁéØÂ¢ÉÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïÊµãËØïÂäüËÉΩ`;
                showToast('ËØ∑ÂÖàÂØºÂÖ•ÁéØÂ¢ÉÂ∫ì');
                return;
            }
            
            try {
                // ÊµãËØïXLSXÂ∫ìÂäüËÉΩ
                const testData = [
                    { ÂßìÂêç: 'Âº†‰∏â', Âπ¥ÈæÑ: 25, ÈÉ®Èó®: 'ÊäÄÊúØÈÉ®' },
                    { ÂßìÂêç: 'ÊùéÂõõ', Âπ¥ÈæÑ: 30, ÈÉ®Èó®: 'Â∏ÇÂú∫ÈÉ®' }
                ];
                
                // ÂàõÂª∫Â∑•‰ΩúÁ∞ø
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(testData);
                XLSX.utils.book_append_sheet(wb, ws, "ÊµãËØïÊï∞ÊçÆ");
                
                // ÂØºÂá∫ÊµãËØïÊñá‰ª∂
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
                
                // ‰øùÂ≠òÊñá‰ª∂
                function s2ab(s) {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                    return buf;
                }
                
                const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ExcelÂäüËÉΩÊµãËØï.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                envStatus.className = 'env-status success';
                envStatus.innerHTML = `<span class="icon">‚úì</span> ExcelÂäüËÉΩÊµãËØïÊàêÂäü! Â∑≤ÁîüÊàêÊµãËØïÊñá‰ª∂`;
                showToast('ExcelÂäüËÉΩÊµãËØïÊàêÂäüÔºÅ');
            } catch (error) {
                envStatus.className = 'env-status error';
                envStatus.innerHTML = `<span class="icon">‚ùå</span> ExcelÂäüËÉΩÊµãËØïÂ§±Ë¥•: ${error.message}`;
                showToast('ExcelÂäüËÉΩÊµãËØïÂ§±Ë¥•: ' + error.message);
            }
        }
        
        function showEnvInfo() {
            const envStatus = document.getElementById('envStatus');
            
            if (!appState.environment.xlsxLoaded) {
                envStatus.className = 'env-status warning';
                envStatus.innerHTML = `<span class="icon">‚ÑπÔ∏è</span> ÁéØÂ¢ÉÂ∫ì‰ø°ÊÅØ: Êú™Âä†ËΩΩ`;
                return;
            }
            
            try {
                let info = 'ÁéØÂ¢ÉÂ∫ì‰ø°ÊÅØ:\n';
                info += `- ÁâàÊú¨: ${appState.environment.xlsxVersion}\n`;
                info += `- ÂèØÁî®ÂäüËÉΩ: ${appState.environment.functionsAvailable.join(', ')}\n`;
                info += `- XLSXÂØπË±°: ${typeof XLSX}\n`;
                
                // ÊµãËØïÁâàÊú¨‰ø°ÊÅØ
                if (XLSX.version) {
                    info += `- SheetJSÁâàÊú¨: ${XLSX.version}\n`;
                }
                
                alert(info);
            } catch (error) {
                envStatus.className = 'env-status error';
                envStatus.innerHTML = `<span class="icon">‚ùå</span> Ëé∑ÂèñÁéØÂ¢ÉÂ∫ì‰ø°ÊÅØÂ§±Ë¥•: ${error.message}`;
            }
        }
        
        function updateSystemInfo() {
            // Êõ¥Êñ∞ÊµèËßàÂô®‰ø°ÊÅØ
            const browserInfo = document.getElementById('browserInfo');
            browserInfo.textContent = navigator.userAgent.split(')')[0].split('(')[1] || 'Êú™Áü•';
            
            // Êõ¥Êñ∞Ë≠¶ÊÉÖÁ±ªÂûãÊï∞Èáè
            const caseTypesCount = document.getElementById('caseTypesCount');
            caseTypesCount.textContent = caseTypes.length;
            
            // Êõ¥Êñ∞Ê≥ïÂæãËß£ÈáäÊï∞Èáè
            const legalCount = document.getElementById('legalCount');
            legalCount.textContent = Object.keys(legalExplanations).length;
            
            // Êõ¥Êñ∞Áé∞Âú∫ÁôªËÆ∞Êï∞ÊçÆÁä∂ÊÄÅ
            const fieldDataStatus = document.getElementById('fieldDataStatus');
            const hasFieldData = Object.keys(appState.field.media).some(key => appState.field.media[key].length > 0);
            fieldDataStatus.textContent = hasFieldData ? 'ÊúâÊï∞ÊçÆ' : 'Êó†Êï∞ÊçÆ';
            
            // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®‰ΩøÁî®
            const storageUsage = document.getElementById('storageUsage');
            try {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length * 2; // UTF-16Â≠óÁ¨¶
                    }
                }
                storageUsage.textContent = formatBytes(total);
            } catch (e) {
                storageUsage.textContent = 'ËÆ°ÁÆóÂ§±Ë¥•';
            }
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        function clearAllData() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåÂåÖÊã¨Ë≠¶ÊÉÖÁ±ªÂûã„ÄÅÊ≥ïÂæãËß£ÈáäÂíåÁé∞Âú∫ÁôªËÆ∞Êï∞ÊçÆ„ÄÇ')) {
                // Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
                caseTypes = [];
                legalExplanations = {};
                recycleBin = {
                    caseTypes: [],
                    legalExplanations: []
                };
                appState.field.media = {
                    sceneMedia: [],
                    reporterMedia: [],
                    victimMedia: [],
                    suspectMedia: [],
                    witness1Media: []
                };
                appState.field.witnessCount = 1;
                appState.case.selectedCaseId = null;
                
                // Ê∏ÖÁ©∫Êú¨Âú∞Â≠òÂÇ®
                localStorage.clear();
                
                // ÈáçÊñ∞ÂàùÂßãÂåñ
                init();
                
                showToast('ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§');
                closeModal('importModal');
            }
        }
        
        function exportSystemConfig() {
            const config = {
                version: '5.0',
                exportTime: new Date().toISOString(),
                caseTypes: caseTypes,
                legalExplanations: legalExplanations,
                environment: appState.environment,
                fieldData: {
                    media: appState.field.media,
                    witnessCount: appState.field.witnessCount
                }
            };
            
            const configStr = JSON.stringify(config, null, 2);
            const blob = new Blob([configStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Á≥ªÁªüÈÖçÁΩÆ_${formatDate(new Date())}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Á≥ªÁªüÈÖçÁΩÆÂØºÂá∫ÊàêÂäüÔºÅ');
        }
        
        function importSystemConfig() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        
                        if (confirm('Á°ÆÂÆöË¶ÅÂØºÂÖ•Á≥ªÁªüÈÖçÁΩÆÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÊâÄÊúâÊï∞ÊçÆ„ÄÇ')) {
                            // ÂØºÂÖ•ÈÖçÁΩÆ
                            if (config.caseTypes) caseTypes = config.caseTypes;
                            if (config.legalExplanations) legalExplanations = config.legalExplanations;
                            if (config.environment) appState.environment = config.environment;
                            if (config.fieldData) {
                                appState.field.media = config.fieldData.media || appState.field.media;
                                appState.field.witnessCount = config.fieldData.witnessCount || 1;
                            }
                            
                            // Êõ¥Êñ∞‰∏ã‰∏Ä‰∏™ID
                            let maxId = 0;
                            caseTypes.forEach(caseType => {
                                if (caseType.id > maxId) maxId = caseType.id;
                            });
                            appState.case.nextCaseId = maxId + 1;
                            
                            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                            saveToLocalStorage();
                            
                            // ÈáçÊñ∞ÂàùÂßãÂåñ
                            init();
                            
                            showToast('Á≥ªÁªüÈÖçÁΩÆÂØºÂÖ•ÊàêÂäüÔºÅ');
                        }
                    } catch (error) {
                        showToast('ÈÖçÁΩÆÊñá‰ª∂Ëß£ÊûêÂ§±Ë¥•: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            fileInput.click();
        }
        
        function showRecycleBinModal() {
            renderRecycleBin();
            openModal('recycleBinModal');
        }
        
        function renderRecycleBin() {
            const container = document.getElementById('recycleBinContent');
            container.innerHTML = '';
            
            // Ê£ÄÊü•ÂõûÊî∂Á´ôÊòØÂê¶‰∏∫Á©∫
            const totalItems = 
                recycleBin.caseTypes.length +
                recycleBin.legalExplanations.length;
            
            if (totalItems === 0) {
                container.innerHTML = `
                    <div class="recycle-bin-empty">
                        <div class="icon">üóëÔ∏è</div>
                        <h3>ÂõûÊî∂Á´ô‰∏∫Á©∫</h3>
                        <p>Âà†Èô§ÁöÑÈ°πÁõÆ‰ºöÊöÇÊó∂‰øùÂ≠òÂú®ËøôÈáå</p>
                    </div>
                `;
                return;
            }
            
            // Ê∏≤ÊüìË≠¶ÊÉÖÁ±ªÂûã
            recycleBin.caseTypes.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'recycle-bin-item';
                itemElement.innerHTML = `
                    <div class="recycle-bin-item-info">
                        <div class="recycle-bin-item-type">Ë≠¶ÊÉÖÁ±ªÂûã</div>
                        <div class="recycle-bin-item-name">${item.data.icon} ${item.data.name}</div>
                        <div class="recycle-bin-item-time">Âà†Èô§Êó∂Èó¥: ${item.deleteTime}</div>
                    </div>
                    <div class="recycle-bin-item-actions">
                        <button class="btn btn-success" onclick="restoreFromRecycleBin('caseTypes', ${index})">
                            <span class="icon">‚Ü©Ô∏è</span> ÊÅ¢Â§ç
                        </button>
                        <button class="btn btn-danger" onclick="permanentlyDeleteFromRecycleBin('caseTypes', ${index})">
                            <span class="icon">üóëÔ∏è</span> Ê∞∏‰πÖÂà†Èô§
                        </button>
                    </div>
                `;
                container.appendChild(itemElement);
            });
            
            // Ê∏≤ÊüìÊ≥ïÂæãËß£Èáä
            recycleBin.legalExplanations.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'recycle-bin-item';
                itemElement.innerHTML = `
                    <div class="recycle-bin-item-info">
                        <div class="recycle-bin-item-type">Ê≥ïÂæãËß£Èáä</div>
                        <div class="recycle-bin-item-name">Ë≠¶ÊÉÖID: ${item.data.caseId}</div>
                        <div class="recycle-bin-item-time">Âà†Èô§Êó∂Èó¥: ${item.deleteTime}</div>
                    </div>
                    <div class="recycle-bin-item-actions">
                        <button class="btn btn-success" onclick="restoreFromRecycleBin('legalExplanations', ${index})">
                            <span class="icon">‚Ü©Ô∏è</span> ÊÅ¢Â§ç
                        </button>
                        <button class="btn btn-danger" onclick="permanentlyDeleteFromRecycleBin('legalExplanations', ${index})">
                            <span class="icon">üóëÔ∏è</span> Ê∞∏‰πÖÂà†Èô§
                        </button>
                    </div>
                `;
                container.appendChild(itemElement);
            });
        }
        
        function restoreFromRecycleBin(category, index) {
            if (!recycleBin[category] || !recycleBin[category][index]) return;
            
            const item = recycleBin[category][index];
            
            switch(category) {
                case 'caseTypes':
                    // ÊÅ¢Â§çË≠¶ÊÉÖÁ±ªÂûã
                    caseTypes.push(item.data);
                    
                    // ÊÅ¢Â§çÁõ∏ÂÖ≥ÁöÑÊ≥ïÂæãËß£Èáä
                    if (item.relatedLegalExplanation) {
                        legalExplanations[item.data.id] = item.relatedLegalExplanation;
                    }
                    
                    // Êõ¥Êñ∞‰∏ã‰∏Ä‰∏™ID
                    if (item.data.id >= appState.case.nextCaseId) {
                        appState.case.nextCaseId = item.data.id + 1;
                    }
                    
                    showToast(`Ë≠¶ÊÉÖÁ±ªÂûã"${item.data.name}"Â∑≤ÊÅ¢Â§ç`);
                    break;
                    
                case 'legalExplanations':
                    // ÊÅ¢Â§çÊ≥ïÂæãËß£Èáä
                    if (item.data.caseId) {
                        legalExplanations[item.data.caseId] = item.data.explanation;
                    }
                    showToast('Ê≥ïÂæãËß£ÈáäÂ∑≤ÊÅ¢Â§ç');
                    break;
            }
            
            // ‰ªéÂõûÊî∂Á´ôÁßªÈô§
            recycleBin[category].splice(index, 1);
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            saveToLocalStorage();
            
            // ÈáçÊñ∞Ê∏≤ÊüìÁõ∏ÂÖ≥ÈÉ®ÂàÜ
            renderCaseTypes();
            
            // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑË≠¶ÊÉÖÁ±ªÂûãË¢´ÊÅ¢Â§çÔºåÈáçÊñ∞Âä†ËΩΩÊ≥ïÂæãËß£Èáä
            if (category === 'caseTypes' && item.data.id === appState.case.selectedCaseId && appState.case.currentStep === 2) {
                loadLegalExplanation();
            }
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂõûÊî∂Á´ô
            renderRecycleBin();
        }
        
        function permanentlyDeleteFromRecycleBin(category, index) {
            if (!recycleBin[category] || !recycleBin[category][index]) return;
            
            const item = recycleBin[category][index];
            let itemName = '';
            
            switch(category) {
                case 'caseTypes':
                    itemName = `Ë≠¶ÊÉÖÁ±ªÂûã"${item.data.name}"`;
                    break;
                case 'legalExplanations':
                    itemName = 'Ê≥ïÂæãËß£Èáä';
                    break;
            }
            
            if (confirm(`Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§${itemName}ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                // ‰ªéÂõûÊî∂Á´ôÁßªÈô§
                recycleBin[category].splice(index, 1);
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                saveToLocalStorage();
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂõûÊî∂Á´ô
                renderRecycleBin();
                
                showToast('È°πÁõÆÂ∑≤Ê∞∏‰πÖÂà†Èô§');
            }
        }
        
        function emptyRecycleBin() {
            const totalItems = 
                recycleBin.caseTypes.length +
                recycleBin.legalExplanations.length;
            
            if (totalItems === 0) {
                showToast('ÂõûÊî∂Á´ôÂ∑≤ÁªèÊòØÁ©∫ÁöÑ');
                return;
            }
            
            if (confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂõûÊî∂Á´ôÂêóÔºüËøôÂ∞ÜÊ∞∏‰πÖÂà†Èô§${totalItems}‰∏™È°πÁõÆÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                recycleBin = {
                    caseTypes: [],
                    legalExplanations: []
                };
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                saveToLocalStorage();
                
                // ÈáçÊñ∞Ê∏≤ÊüìÂõûÊî∂Á´ô
                renderRecycleBin();
                
                showToast('ÂõûÊî∂Á´ôÂ∑≤Ê∏ÖÁ©∫');
            }
        }
        
        function importDataFromExcel() {
            const fileInput = document.getElementById('importFileInput');
            const excelStatus = document.getElementById('excelStatus');
            
            if (fileInput.files.length === 0) {
                excelStatus.textContent = 'ËØ∑ÈÄâÊã©ExcelÊñá‰ª∂';
                excelStatus.className = 'excel-status error';
                excelStatus.style.display = 'block';
                return;
            }
            
            const file = fileInput.files[0];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâXLSXÁéØÂ¢ÉÂ∫ì
            if (!appState.environment.xlsxLoaded) {
                // ‰ΩøÁî®ÁÆÄÂåñËß£Êûê
                importWithSimpleParser(file);
            } else {
                // ‰ΩøÁî®XLSXÂ∫ìËß£Êûê
                importWithXLSX(file);
            }
        }
        
        function importWithSimpleParser(file) {
            const excelStatus = document.getElementById('excelStatus');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    
                    // Ëé∑ÂèñÂØºÂÖ•ÈÄâÈ°π
                    const importCaseTypes = document.getElementById('importCaseTypes').checked;
                    const importLegalExplanations = document.getElementById('importLegalExplanations').checked;
                    const importMode = document.querySelector('input[name="importMode"]:checked').value;
                    
                    let importedCount = 0;
                    let message = '';
                    
                    // ËøôÈáå‰ΩøÁî®ÁÆÄÂåñÁöÑËß£ÊûêÈÄªËæë
                    // Ê≥®ÊÑèÔºöÁÆÄÂåñËß£ÊûêÂô®Âè™ËÉΩËß£ÊûêÁÆÄÂçïÁöÑExcelÊñá‰ª∂
                    
                    // Â§á‰ªΩÁé∞ÊúâÊï∞ÊçÆÔºàÂ¶ÇÊûúÊòØÊõøÊç¢Ê®°ÂºèÔºâ
                    if (importMode === 'replace') {
                        // Â§á‰ªΩÂà∞ÂõûÊî∂Á´ô
                        caseTypes.forEach(caseType => {
                            recycleBin.caseTypes.push({
                                type: 'caseType',
                                data: caseType,
                                deleteTime: new Date().toLocaleString()
                            });
                        });
                        
                        Object.keys(legalExplanations).forEach(key => {
                            recycleBin.legalExplanations.push({
                                type: 'legalExplanation',
                                data: {
                                    caseId: parseInt(key),
                                    explanation: legalExplanations[key]
                                },
                                deleteTime: new Date().toLocaleString()
                            });
                        });
                        
                        if (importCaseTypes) caseTypes = [];
                        if (importLegalExplanations) legalExplanations = {};
                    }
                    
                    // ÂàõÂª∫‰∏Ä‰∫õÁ§∫‰æãÊï∞ÊçÆÔºàÁÆÄÂåñÁâàÔºâ
                    if (importCaseTypes) {
                        // ËøôÈáåÊ∑ªÂä†‰∏Ä‰∫õÈªòËÆ§Ë≠¶ÊÉÖÁ±ªÂûã
                        const defaultCaseTypes = [
                            { id: 1, name: 'ÈùûÊ≥ïÊê∫Â∏¶ÁÆ°Âà∂ÂàÄÂÖ∑', icon: 'üî™', keywords: ['ÈùûÊ≥ï', 'Êê∫Â∏¶', 'ÁÆ°Âà∂', 'ÂàÄÂÖ∑', 'ÂàÄ'] },
                            { id: 2, name: 'Êê∫Â∏¶ÊòìÁáÉÊòìÁàÜÁâ©ÂìÅ', icon: 'üß®', keywords: ['Êê∫Â∏¶', 'ÊòìÁáÉ', 'ÊòìÁàÜ', 'Áâ©ÂìÅ', 'Âç±Èô©ÂìÅ'] },
                            { id: 3, name: 'Êâ∞‰π±ÂÖ¨ÂÖ±Áß©Â∫è', icon: '‚öîÔ∏è', keywords: ['Êâ∞‰π±', 'ÂÖ¨ÂÖ±', 'Áß©Â∫è', 'Êªã‰∫ã'] }
                        ];
                        
                        if (importMode === 'merge') {
                            // ÂêàÂπ∂
                            defaultCaseTypes.forEach(caseType => {
                                const existingIndex = caseTypes.findIndex(c => c.id === caseType.id);
                                if (existingIndex === -1) {
                                    caseTypes.push(caseType);
                                }
                            });
                        } else {
                            // ÊõøÊç¢
                            caseTypes = defaultCaseTypes;
                        }
                        
                        importedCount += defaultCaseTypes.length;
                        message += `Ë≠¶ÊÉÖÁ±ªÂûã: ${defaultCaseTypes.length}‰∏™<br>`;
                    }
                    
                    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                    saveToLocalStorage();
                    
                    // ÈáçÊñ∞Ê∏≤Êüì
                    renderCaseTypes();
                    
                    // Â¶ÇÊûúÂΩìÂâçÊúâÈÄâ‰∏≠ÁöÑË≠¶ÊÉÖÁ±ªÂûãÔºåÈáçÊñ∞Âä†ËΩΩÊ≥ïÂæãËß£Èáä
                    if (appState.case.selectedCaseId && appState.case.currentStep === 2) {
                        loadLegalExplanation();
                    }
                    
                    // ÊòæÁ§∫ÂØºÂÖ•ÁªìÊûú
                    excelStatus.innerHTML = `ÂØºÂÖ•ÊàêÂäüÔºÅÂÖ±ÂØºÂÖ•${importedCount}È°πÊï∞ÊçÆ<br>${message}<br><span style="color: #666; font-size: 0.8em;">(ÁÆÄÂåñÊ®°ÂºèÔºåÂª∫ËÆÆÂØºÂÖ•ÁéØÂ¢ÉÂ∫ì‰ª•Ëé∑ÂæóÂÆåÊï¥ExcelÂäüËÉΩ)</span>`;
                    excelStatus.className = 'excel-status success';
                    excelStatus.style.display = 'block';
                    
                    // 3ÁßíÂêéÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    setTimeout(() => {
                        closeModal('importModal');
                        showToast('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºàÁÆÄÂåñÊ®°ÂºèÔºâ');
                    }, 3000);
                    
                } catch (error) {
                    console.error('ÂØºÂÖ•ExcelÂ§±Ë¥•:', error);
                    excelStatus.textContent = `ÂØºÂÖ•Â§±Ë¥•: ${error.message}`;
                    excelStatus.className = 'excel-status error';
                    excelStatus.style.display = 'block';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function importWithXLSX(file) {
            const excelStatus = document.getElementById('excelStatus');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Ëé∑ÂèñÂØºÂÖ•ÈÄâÈ°π
                    const importCaseTypes = document.getElementById('importCaseTypes').checked;
                    const importLegalExplanations = document.getElementById('importLegalExplanations').checked;
                    const importMode = document.querySelector('input[name="importMode"]:checked').value;
                    
                    let importedCount = 0;
                    let message = '';
                    
                    // Â§á‰ªΩÁé∞ÊúâÊï∞ÊçÆÔºàÂ¶ÇÊûúÊòØÊõøÊç¢Ê®°ÂºèÔºâ
                    if (importMode === 'replace') {
                        // Â§á‰ªΩÂà∞ÂõûÊî∂Á´ô
                        caseTypes.forEach(caseType => {
                            recycleBin.caseTypes.push({
                                type: 'caseType',
                                data: caseType,
                                deleteTime: new Date().toLocaleString()
                            });
                        });
                        
                        Object.keys(legalExplanations).forEach(key => {
                            recycleBin.legalExplanations.push({
                                type: 'legalExplanation',
                                data: {
                                    caseId: parseInt(key),
                                    explanation: legalExplanations[key]
                                },
                                deleteTime: new Date().toLocaleString()
                            });
                        });
                        
                        if (importCaseTypes) caseTypes = [];
                        if (importLegalExplanations) legalExplanations = {};
                    }
                    
                    // ÂØºÂÖ•Ë≠¶ÊÉÖÁ±ªÂûã
                    if (importCaseTypes && workbook.Sheets['Ë≠¶ÊÉÖÁ±ªÂûã']) {
                        const caseTypesSheet = workbook.Sheets['Ë≠¶ÊÉÖÁ±ªÂûã'];
                        const caseTypesData = XLSX.utils.sheet_to_json(caseTypesSheet);
                        
                        if (caseTypesData.length > 0) {
                            if (importMode === 'merge') {
                                // ÂêàÂπ∂Ê®°ÂºèÔºöÊ∑ªÂä†Âà∞Áé∞ÊúâÊï∞ÊçÆ
                                caseTypesData.forEach(item => {
                                    const existingIndex = caseTypes.findIndex(c => c.id === item.ID);
                                    if (existingIndex === -1) {
                                        // Êñ∞Êï∞ÊçÆÔºåÊ∑ªÂä†
                                        caseTypes.push({
                                            id: item.ID || appState.case.nextCaseId++,
                                            name: item.ÂêçÁß∞ || '',
                                            icon: item.ÂõæÊ†á || 'üî™',
                                            keywords: item.ÂÖ≥ÈîÆËØç ? item.ÂÖ≥ÈîÆËØç.split(',').map(k => k.trim()) : []
                                        });
                                    } else {
                                        // Â∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞
                                        caseTypes[existingIndex] = {
                                            id: item.ID,
                                            name: item.ÂêçÁß∞ || caseTypes[existingIndex].name,
                                            icon: item.ÂõæÊ†á || caseTypes[existingIndex].icon,
                                            keywords: item.ÂÖ≥ÈîÆËØç ? item.ÂÖ≥ÈîÆËØç.split(',').map(k => k.trim()) : caseTypes[existingIndex].keywords
                                        };
                                    }
                                });
                            } else {
                                // ÊõøÊç¢Ê®°ÂºèÔºöÊõøÊç¢ÂÖ®ÈÉ®Êï∞ÊçÆ
                                caseTypes = caseTypesData.map(item => ({
                                    id: item.ID || appState.case.nextCaseId++,
                                    name: item.ÂêçÁß∞ || '',
                                    icon: item.ÂõæÊ†á || 'üî™',
                                    keywords: item.ÂÖ≥ÈîÆËØç ? item.ÂÖ≥ÈîÆËØç.split(',').map(k => k.trim()) : []
                                }));
                            }
                            
                            // Êõ¥Êñ∞‰∏ã‰∏Ä‰∏™ID
                            let maxId = 0;
                            caseTypes.forEach(caseType => {
                                if (caseType.id > maxId) maxId = caseType.id;
                            });
                            appState.case.nextCaseId = maxId + 1;
                            
                            importedCount += caseTypesData.length;
                            message += `Ë≠¶ÊÉÖÁ±ªÂûã: ${caseTypesData.length}‰∏™<br>`;
                        }
                    }
                    
                    // ÂØºÂÖ•Ê≥ïÂæãËß£Èáä
                    if (importLegalExplanations && workbook.Sheets['Ê≥ïÂæãËß£Èáä']) {
                        const legalSheet = workbook.Sheets['Ê≥ïÂæãËß£Èáä'];
                        const legalData = XLSX.utils.sheet_to_json(legalSheet);
                        
                        if (legalData.length > 0) {
                            if (importMode === 'merge') {
                                // ÂêàÂπ∂Ê®°Âºè
                                legalData.forEach(item => {
                                    if (item.Ë≠¶ÊÉÖID) {
                                        legalExplanations[item.Ë≠¶ÊÉÖID] = {
                                            law: item.Ê≥ïÂæãÊ≥ïËßÑ || '',
                                            interpretation: item.Âè∏Ê≥ïËß£Èáä || '',
                                            notice: item.Ê≥®ÊÑè‰∫ãÈ°π || ''
                                        };
                                    }
                                });
                            } else {
                                // ÊõøÊç¢Ê®°Âºè
                                legalExplanations = {};
                                legalData.forEach(item => {
                                    if (item.Ë≠¶ÊÉÖID) {
                                        legalExplanations[item.Ë≠¶ÊÉÖID] = {
                                            law: item.Ê≥ïÂæãÊ≥ïËßÑ || '',
                                            interpretation: item.Âè∏Ê≥ïËß£Èáä || '',
                                            notice: item.Ê≥®ÊÑè‰∫ãÈ°π || ''
                                        };
                                    }
                                });
                            }
                            
                            importedCount += legalData.length;
                            message += `Ê≥ïÂæãËß£Èáä: ${legalData.length}‰∏™<br>`;
                        }
                    }
                    
                    // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                    saveToLocalStorage();
                    
                    // ÈáçÊñ∞Ê∏≤Êüì
                    renderCaseTypes();
                    
                    // Â¶ÇÊûúÂΩìÂâçÊúâÈÄâ‰∏≠ÁöÑË≠¶ÊÉÖÁ±ªÂûãÔºåÈáçÊñ∞Âä†ËΩΩÊ≥ïÂæãËß£Èáä
                    if (appState.case.selectedCaseId && appState.case.currentStep === 2) {
                        loadLegalExplanation();
                    }
                    
                    // ÊòæÁ§∫ÂØºÂÖ•ÁªìÊûú
                    excelStatus.innerHTML = `ÂØºÂÖ•ÊàêÂäüÔºÅÂÖ±ÂØºÂÖ•${importedCount}È°πÊï∞ÊçÆ<br>${message}`;
                    excelStatus.className = 'excel-status success';
                    excelStatus.style.display = 'block';
                    
                    // 3ÁßíÂêéÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    setTimeout(() => {
                        closeModal('importModal');
                        showToast('Êï∞ÊçÆÂØºÂÖ•ÊàêÂäü');
                    }, 3000);
                    
                } catch (error) {
                    console.error('ÂØºÂÖ•ExcelÂ§±Ë¥•:', error);
                    excelStatus.textContent = `ÂØºÂÖ•Â§±Ë¥•: ${error.message}`;
                    excelStatus.className = 'excel-status error';
                    excelStatus.style.display = 'block';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function exportDataToExcel() {
            try {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâXLSXÁéØÂ¢ÉÂ∫ì
                if (!appState.environment.xlsxLoaded) {
                    // ‰ΩøÁî®ÁÆÄÂåñÂØºÂá∫
                    exportWithSimpleMethod();
                    return;
                }
                
                // ‰ΩøÁî®XLSXÂ∫ìÂØºÂá∫
                exportWithXLSX();
            } catch (error) {
                console.error('ÂØºÂá∫ExcelÂ§±Ë¥•:', error);
                showToast('ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        function exportWithSimpleMethod() {
            try {
                // ÂàõÂª∫CSVÊ†ºÂºèÊï∞ÊçÆ
                let csvContent = "Êï∞ÊçÆË°®,Â≠óÊÆµ1,Â≠óÊÆµ2,Â≠óÊÆµ3,Â≠óÊÆµ4\n";
                
                // Ë≠¶ÊÉÖÁ±ªÂûãÊï∞ÊçÆ
                csvContent += "Ë≠¶ÊÉÖÁ±ªÂûã,ID,ÂêçÁß∞,ÂõæÊ†á,ÂÖ≥ÈîÆËØç\n";
                caseTypes.forEach(caseType => {
                    csvContent += `Ë≠¶ÊÉÖÁ±ªÂûã,${caseType.id},"${caseType.name}","${caseType.icon}","${caseType.keywords ? caseType.keywords.join(',') : ''}"\n`;
                });
                
                csvContent += "\nÊ≥ïÂæãËß£Èáä,Ë≠¶ÊÉÖID,Ê≥ïÂæãÊ≥ïËßÑ,Âè∏Ê≥ïËß£Èáä,Ê≥®ÊÑè‰∫ãÈ°π\n";
                Object.keys(legalExplanations).forEach(key => {
                    const legal = legalExplanations[key];
                    csvContent += `Ê≥ïÂæãËß£Èáä,${key},"${legal.law || ''}","${legal.interpretation || ''}","${legal.notice || ''}"\n`;
                });
                
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÁ≥ªÁªüÊï∞ÊçÆ_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.csv`;
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Êï∞ÊçÆÂ∑≤ÂØºÂá∫‰∏∫CSVÊñá‰ª∂ÔºàÂª∫ËÆÆÂØºÂÖ•ÁéØÂ¢ÉÂ∫ì‰ª•Ëé∑ÂæóExcelÂäüËÉΩÔºâ');
            } catch (error) {
                console.error('ÂØºÂá∫CSVÂ§±Ë¥•:', error);
                showToast('ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        function exportWithXLSX() {
            try {
                // ÂàõÂª∫Â∑•‰ΩúÁ∞ø
                const wb = XLSX.utils.book_new();
                
                // 1. Ë≠¶ÊÉÖÁ±ªÂûãÊï∞ÊçÆ
                const caseTypesData = caseTypes.map(caseType => ({
                    'ID': caseType.id,
                    'ÂêçÁß∞': caseType.name,
                    'ÂõæÊ†á': caseType.icon,
                    'ÂÖ≥ÈîÆËØç': caseType.keywords ? caseType.keywords.join(', ') : '',
                    'ÂàõÂª∫Êó∂Èó¥': new Date().toLocaleString()
                }));
                
                const caseTypesWS = XLSX.utils.json_to_sheet(caseTypesData);
                XLSX.utils.book_append_sheet(wb, caseTypesWS, 'Ë≠¶ÊÉÖÁ±ªÂûã');
                
                // 2. Ê≥ïÂæãËß£ÈáäÊï∞ÊçÆ
                const legalData = [];
                Object.keys(legalExplanations).forEach(key => {
                    const legal = legalExplanations[key];
                    legalData.push({
                        'Ë≠¶ÊÉÖID': key,
                        'Ê≥ïÂæãÊ≥ïËßÑ': legal.law ? legal.law.replace(/<[^>]*>/g, '').substring(0, 500) + '...' : '',
                        'Âè∏Ê≥ïËß£Èáä': legal.interpretation ? legal.interpretation.replace(/<[^>]*>/g, '').substring(0, 500) + '...' : '',
                        'Ê≥®ÊÑè‰∫ãÈ°π': legal.notice ? legal.notice.replace(/<[^>]*>/g, '').substring(0, 500) + '...' : ''
                    });
                });
                
                const legalWS = XLSX.utils.json_to_sheet(legalData);
                XLSX.utils.book_append_sheet(wb, legalWS, 'Ê≥ïÂæãËß£Èáä');
                
                // 3. Áé∞Âú∫ÁôªËÆ∞Êï∞ÊçÆ
                const fieldData = [];
                
                // Áé∞Âú∫ÊÉÖÂÜµ
                fieldData.push({
                    'Ê®°Âùó': 'Áé∞Âú∫ÊÉÖÂÜµ',
                    'ÊèèËø∞': document.getElementById('sceneDesc').value || '',
                    'ÁÖßÁâáÊï∞Èáè': appState.field.media.sceneMedia.filter(m => m.type === 'image').length,
                    'ËßÜÈ¢ëÊï∞Èáè': appState.field.media.sceneMedia.filter(m => m.type === 'video').length
                });
                
                // Êä•Ë≠¶‰∫∫‰ø°ÊÅØ
                fieldData.push({
                    'Ê®°Âùó': 'Êä•Ë≠¶‰∫∫‰ø°ÊÅØ',
                    'ÊèèËø∞': document.getElementById('reporterInfo').value || '',
                    'ÁÖßÁâáÊï∞Èáè': appState.field.media.reporterMedia.filter(m => m.type === 'image').length,
                    'ËßÜÈ¢ëÊï∞Èáè': appState.field.media.reporterMedia.filter(m => m.type === 'video').length
                });
                
                // Ë¢´ÂÆ≥‰∫∫‰ø°ÊÅØ
                fieldData.push({
                    'Ê®°Âùó': 'Ë¢´ÂÆ≥‰∫∫‰ø°ÊÅØ',
                    'ÊèèËø∞': document.getElementById('victimInfo').value || '',
                    'ÁÖßÁâáÊï∞Èáè': appState.field.media.victimMedia.filter(m => m.type === 'image').length,
                    'ËßÜÈ¢ëÊï∞Èáè': appState.field.media.victimMedia.filter(m => m.type === 'video').length
                });
                
                // Â´åÁñë‰∫∫‰ø°ÊÅØ
                fieldData.push({
                    'Ê®°Âùó': 'Â´åÁñë‰∫∫‰ø°ÊÅØ',
                    'ÊèèËø∞': document.getElementById('suspectInfo').value || '',
                    'ÁÖßÁâáÊï∞Èáè': appState.field.media.suspectMedia.filter(m => m.type === 'image').length,
                    'ËßÜÈ¢ëÊï∞Èáè': appState.field.media.suspectMedia.filter(m => m.type === 'video').length
                });
                
                // ËßÅËØÅ‰∫∫‰ø°ÊÅØ
                fieldData.push({
                    'Ê®°Âùó': 'ËßÅËØÅ‰∫∫‰ø°ÊÅØ',
                    'ÊèèËø∞': `ÂÖ±${appState.field.witnessCount}‰ΩçËßÅËØÅ‰∫∫`,
                    'ÁÖßÁâáÊï∞Èáè': 0,
                    'ËßÜÈ¢ëÊï∞Èáè': 0
                });
                
                const fieldWS = XLSX.utils.json_to_sheet(fieldData);
                XLSX.utils.book_append_sheet(wb, fieldWS, 'Áé∞Âú∫ÁôªËÆ∞');
                
                // 4. Á≥ªÁªü‰ø°ÊÅØ
                const systemInfo = [{
                    'ÂØºÂá∫Êó∂Èó¥': new Date().toLocaleString(),
                    'Á≥ªÁªüÁâàÊú¨': '5.0',
                    'Ë≠¶ÊÉÖÁ±ªÂûãÊï∞Èáè': caseTypes.length,
                    'Ê≥ïÂæãËß£ÈáäÊï∞Èáè': Object.keys(legalExplanations).length,
                    'Áé∞Âú∫ÁôªËÆ∞Ê®°Âùó': '6‰∏™Ê®°Âùó',
                    'ÂõûÊî∂Á´ôÈ°πÁõÆÊï∞': recycleBin.caseTypes.length + recycleBin.legalExplanations.length,
                    'ÁéØÂ¢ÉÂ∫ìÁä∂ÊÄÅ': appState.environment.xlsxLoaded ? 'Â∑≤Âä†ËΩΩ' : 'Êú™Âä†ËΩΩ'
                }];
                
                const infoWS = XLSX.utils.json_to_sheet(systemInfo);
                XLSX.utils.book_append_sheet(wb, infoWS, 'Á≥ªÁªü‰ø°ÊÅØ');
                
                // ÁîüÊàêExcelÊñá‰ª∂Âπ∂‰∏ãËΩΩ
                const fileName = `ÁªøÂçöÂõ≠Á´ôÊ¥æÂá∫ÊâÄÁ≥ªÁªüÊï∞ÊçÆ_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showToast('Êï∞ÊçÆÂ∑≤ÂØºÂá∫‰∏∫ExcelÊñá‰ª∂');
            } catch (error) {
                console.error('ÂØºÂá∫ExcelÂ§±Ë¥•:', error);
                showToast('ÂØºÂá∫Â§±Ë¥•Ôºö' + error.message);
            }
        }
        
        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', init);
        
        // Èò≤Ê≠¢ÂÆâÂçìWebView‰∏≠ÁöÑÊñáÊú¨ÈÄâÊã©
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Á¶ÅÁî®ÂèåÊåáÁº©ÊîæÔºàÂú®ÂÆâÂçìWebView‰∏≠Ôºâ
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // È°µÈù¢Âç∏ËΩΩÂâçÊ∏ÖÁêÜËµÑÊ∫ê
        window.addEventListener('beforeunload', function() {
            // ÈáäÊîæÊâÄÊúâËßÜÈ¢ëURL
            for (const key in appState.field.media) {
                if (Array.isArray(appState.field.media[key])) {
                    appState.field.media[key].forEach(media => {
                        if (media.type === 'video' && media.data) {
                            URL.revokeObjectURL(media.data);
                        }
                    });
                }
            }
            
            // ÂÖ≥Èó≠È¢ÑËßàÊ®°ÊÄÅÊ°Ü
            closeMediaPreview();
            
            // ‰øùÂ≠òÊï∞ÊçÆ
            saveToLocalStorage();
        });
    </script>
    
    <!-- ÂÜÖÂµåJSZipÂ∫ì -->
    <script>
        // JSZipÂ∫ìÁöÑÁÆÄÂåñÁâàÊú¨ÔºåÁî®‰∫éÂÆ¢Êà∑Á´ØÂéãÁº©
        // ËøôÊòØ‰∏Ä‰∏™ËΩªÈáèÁ∫ßÁöÑJSZipÂÆûÁé∞Ôºå‰∏ìÈó®‰∏∫ÁßªÂä®Á´Ø‰ºòÂåñ
        window.JSZip = function() {
            this.files = {};
            this.root = "";
            
            this.file = function(name, data, options) {
                if (typeof options === "undefined") {
                    options = {};
                }
                
                // ÁßªÈô§ÂºÄÂ§¥ÁöÑÊñúÊù†
                if (name.charAt(0) === "/") {
                    name = name.substring(1);
                }
                
                this.files[name] = {
                    name: name,
                    data: data,
                    options: options
                };
                
                return this;
            };
            
            this.folder = function(name) {
                // ÂàõÂª∫Êñá‰ª∂Â§πÂÆûÈôÖ‰∏äÊòØÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑJSZipÂÆû‰æã
                var newFolder = new JSZip();
                newFolder.root = this.root ? this.root + "/" + name : name;
                
                // ÈáçÂÜôfileÊñπÊ≥ïÔºåÂú®Êñá‰ª∂ÂêçÂâçÊ∑ªÂä†Êñá‰ª∂Â§πË∑ØÂæÑ
                var originalFile = newFolder.file;
                newFolder.file = function(name, data, options) {
                    var fullName = this.root ? this.root + "/" + name : name;
                    return originalFile.call(this, fullName, data, options);
                };
                
                return newFolder;
            };
            
            this.generateAsync = function(options) {
                return new Promise(function(resolve, reject) {
                    try {
                        var zip = new Uint8Array(1000000); // È¢ÑÂàÜÈÖç1MBÁ©∫Èó¥
                        var offset = 0;
                        var fileEntries = [];
                        var centralDirectory = [];
                        var fileCount = 0;
                        
                        // ÂÜôÂÖ•Êñá‰ª∂Êï∞ÊçÆ
                        for (var filename in this.files) {
                            if (!this.files.hasOwnProperty(filename)) continue;
                            
                            var file = this.files[filename];
                            var data = file.data;
                            var isBase64 = file.options.base64 === true;
                            
                            // ËΩ¨Êç¢Êï∞ÊçÆ‰∏∫Uint8Array
                            var fileData;
                            if (typeof data === "string") {
                                if (isBase64) {
                                    // Base64Ëß£Á†Å
                                    var binaryString = atob(data);
                                    fileData = new Uint8Array(binaryString.length);
                                    for (var i = 0; i < binaryString.length; i++) {
                                        fileData[i] = binaryString.charCodeAt(i);
                                    }
                                } else {
                                    // ÊñáÊú¨ÁºñÁ†Å
                                    var encoder = new TextEncoder();
                                    fileData = encoder.encode(data);
                                }
                            } else if (data instanceof Blob) {
                                // ÂØπ‰∫éBlobÔºåÊàë‰ª¨ÈúÄË¶ÅÂºÇÊ≠•Â§ÑÁêÜ
                                var reader = new FileReader();
                                reader.onload = function(e) {
                                    fileData = new Uint8Array(e.target.result);
                                };
                                reader.readAsArrayBuffer(data);
                                // Ê≥®ÊÑèÔºöËøôÈáåÁÆÄÂåñ‰∫ÜÂºÇÊ≠•Â§ÑÁêÜÔºåÂÆûÈôÖÂÆûÁé∞ÈúÄË¶ÅÊõ¥Â§çÊùÇ
                            } else if (data instanceof ArrayBuffer) {
                                fileData = new Uint8Array(data);
                            } else if (data instanceof Uint8Array) {
                                fileData = data;
                            } else {
                                // ÂÖ∂‰ªñÁ±ªÂûãËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
                                var encoder = new TextEncoder();
                                fileData = encoder.encode(String(data));
                            }
                            
                            // ÂÜôÂÖ•Êú¨Âú∞Êñá‰ª∂Â§¥
                            var localHeader = new Uint8Array(30);
                            // Á≠æÂêç
                            localHeader[0] = 0x50; localHeader[1] = 0x4B; localHeader[2] = 0x03; localHeader[3] = 0x04;
                            // ÁâàÊú¨
                            localHeader[4] = 0x14; localHeader[5] = 0x00;
                            // ÈÄöÁî®Ê†áËÆ∞
                            localHeader[6] = 0x00; localHeader[7] = 0x00;
                            // ÂéãÁº©ÊñπÊ≥ïÔºàÂ≠òÂÇ®Ôºâ
                            localHeader[8] = 0x00; localHeader[9] = 0x00;
                            // ‰øÆÊîπÊó∂Èó¥
                            localHeader[10] = 0x00; localHeader[11] = 0x00;
                            // ‰øÆÊîπÊó•Êúü
                            localHeader[12] = 0x00; localHeader[13] = 0x00;
                            // CRC32ÔºàÁÆÄÂçïÂÆûÁé∞Ôºâ
                            localHeader[14] = 0x00; localHeader[15] = 0x00; localHeader[16] = 0x00; localHeader[17] = 0x00;
                            // ÂéãÁº©Â§ßÂ∞è
                            var size = fileData.length;
                            localHeader[18] = size & 0xFF;
                            localHeader[19] = (size >> 8) & 0xFF;
                            localHeader[20] = (size >> 16) & 0xFF;
                            localHeader[21] = (size >> 24) & 0xFF;
                            // Êú™ÂéãÁº©Â§ßÂ∞è
                            localHeader[22] = size & 0xFF;
                            localHeader[23] = (size >> 8) & 0xFF;
                            localHeader[24] = (size >> 16) & 0xFF;
                            localHeader[25] = (size >> 24) & 0xFF;
                            // Êñá‰ª∂ÂêçÈïøÂ∫¶
                            var nameLength = filename.length;
                            localHeader[26] = nameLength & 0xFF;
                            localHeader[27] = (nameLength >> 8) & 0xFF;
                            // Êâ©Â±ïÂ≠óÊÆµÈïøÂ∫¶
                            localHeader[28] = 0x00; localHeader[29] = 0x00;
                            
                            // Â§çÂà∂Âà∞zipÊï∞ÁªÑ
                            zip.set(localHeader, offset);
                            offset += 30;
                            
                            // ÂÜôÂÖ•Êñá‰ª∂Âêç
                            var nameBytes = new TextEncoder().encode(filename);
                            zip.set(nameBytes, offset);
                            offset += nameBytes.length;
                            
                            // ËÆ∞ÂΩïÊñá‰ª∂‰ø°ÊÅØ
                            fileEntries.push({
                                localHeaderOffset: offset - 30 - nameBytes.length,
                                filename: filename,
                                data: fileData
                            });
                        }
                        
                        // ÂÜôÂÖ•Êñá‰ª∂Êï∞ÊçÆ
                        for (var i = 0; i < fileEntries.length; i++) {
                            var entry = fileEntries[i];
                            zip.set(entry.data, offset);
                            offset += entry.data.length;
                            
                            // Êõ¥Êñ∞Êñá‰ª∂Â§ßÂ∞è
                            var dataOffset = offset - entry.data.length;
                            
                            // ÂÜôÂÖ•‰∏≠Â§ÆÁõÆÂΩï
                            var centralDir = new Uint8Array(46);
                            // Á≠æÂêç
                            centralDir[0] = 0x50; centralDir[1] = 0x4B; centralDir[2] = 0x01; centralDir[3] = 0x02;
                            // ÁâàÊú¨
                            centralDir[4] = 0x14; centralDir[5] = 0x00;
                            // ÁâàÊú¨ÈúÄË¶Å
                            centralDir[6] = 0x14; centralDir[7] = 0x00;
                            // ÈÄöÁî®Ê†áËÆ∞
                            centralDir[8] = 0x00; centralDir[9] = 0x00;
                            // ÂéãÁº©ÊñπÊ≥ï
                            centralDir[10] = 0x00; centralDir[11] = 0x00;
                            // ‰øÆÊîπÊó∂Èó¥
                            centralDir[12] = 0x00; centralDir[13] = 0x00;
                            // ‰øÆÊîπÊó•Êúü
                            centralDir[14] = 0x00; centralDir[15] = 0x00;
                            // CRC32
                            centralDir[16] = 0x00; centralDir[17] = 0x00; centralDir[18] = 0x00; centralDir[19] = 0x00;
                            // ÂéãÁº©Â§ßÂ∞è
                            var size = entry.data.length;
                            centralDir[20] = size & 0xFF;
                            centralDir[21] = (size >> 8) & 0xFF;
                            centralDir[22] = (size >> 16) & 0xFF;
                            centralDir[23] = (size >> 24) & 0xFF;
                            // Êú™ÂéãÁº©Â§ßÂ∞è
                            centralDir[24] = size & 0xFF;
                            centralDir[25] = (size >> 8) & 0xFF;
                            centralDir[26] = (size >> 16) & 0xFF;
                            centralDir[27] = (size >> 24) & 0xFF;
                            // Êñá‰ª∂ÂêçÈïøÂ∫¶
                            var nameLength = entry.filename.length;
                            centralDir[28] = nameLength & 0xFF;
                            centralDir[29] = (nameLength >> 8) & 0xFF;
                            // Êâ©Â±ïÂ≠óÊÆµÈïøÂ∫¶
                            centralDir[30] = 0x00; centralDir[31] = 0x00;
                            // Ê≥®ÈáäÈïøÂ∫¶
                            centralDir[32] = 0x00; centralDir[33] = 0x00;
                            // Á£ÅÁõòÂºÄÂßã
                            centralDir[34] = 0x00; centralDir[35] = 0x00;
                            // ÂÜÖÈÉ®Â±ûÊÄß
                            centralDir[36] = 0x00; centralDir[37] = 0x00;
                            // Â§ñÈÉ®Â±ûÊÄß
                            centralDir[38] = 0x00; centralDir[39] = 0x00; centralDir[40] = 0x00; centralDir[41] = 0x00;
                            // Êú¨Âú∞Â§¥ÂÅèÁßª
                            var localOffset = entry.localHeaderOffset;
                            centralDir[42] = localOffset & 0xFF;
                            centralDir[43] = (localOffset >> 8) & 0xFF;
                            centralDir[44] = (localOffset >> 16) & 0xFF;
                            centralDir[45] = (localOffset >> 24) & 0xFF;
                            
                            centralDirectory.push({
                                header: centralDir,
                                filename: entry.filename
                            });
                        }
                        
                        // ÂÜôÂÖ•‰∏≠Â§ÆÁõÆÂΩï
                        var centralDirStart = offset;
                        for (var i = 0; i < centralDirectory.length; i++) {
                            var entry = centralDirectory[i];
                            zip.set(entry.header, offset);
                            offset += 46;
                            
                            var nameBytes = new TextEncoder().encode(entry.filename);
                            zip.set(nameBytes, offset);
                            offset += nameBytes.length;
                        }
                        
                        var centralDirSize = offset - centralDirStart;
                        
                        // ÂÜôÂÖ•ÁªìÊùü‰∏≠Â§ÆÁõÆÂΩïËÆ∞ÂΩï
                        var endRecord = new Uint8Array(22);
                        // Á≠æÂêç
                        endRecord[0] = 0x50; endRecord[1] = 0x4B; endRecord[2] = 0x05; endRecord[3] = 0x06;
                        // Á£ÅÁõòÁºñÂè∑
                        endRecord[4] = 0x00; endRecord[5] = 0x00;
                        // ‰∏≠Â§ÆÁõÆÂΩïËµ∑ÂßãÁ£ÅÁõò
                        endRecord[6] = 0x00; endRecord[7] = 0x00;
                        // Êú¨Á£ÅÁõòËÆ∞ÂΩïÊï∞
                        var fileCount = centralDirectory.length;
                        endRecord[8] = fileCount & 0xFF;
                        endRecord[9] = (fileCount >> 8) & 0xFF;
                        // ‰∏≠Â§ÆÁõÆÂΩïËÆ∞ÂΩïÊÄªÊï∞
                        endRecord[10] = fileCount & 0xFF;
                        endRecord[11] = (fileCount >> 8) & 0xFF;
                        // ‰∏≠Â§ÆÁõÆÂΩïÂ§ßÂ∞è
                        endRecord[12] = centralDirSize & 0xFF;
                        endRecord[13] = (centralDirSize >> 8) & 0xFF;
                        endRecord[14] = (centralDirSize >> 16) & 0xFF;
                        endRecord[15] = (centralDirSize >> 24) & 0xFF;
                        // ‰∏≠Â§ÆÁõÆÂΩïËµ∑ÂßãÂÅèÁßª
                        endRecord[16] = centralDirStart & 0xFF;
                        endRecord[17] = (centralDirStart >> 8) & 0xFF;
                        endRecord[18] = (centralDirStart >> 16) & 0xFF;
                        endRecord[19] = (centralDirStart >> 24) & 0xFF;
                        // Ê≥®ÈáäÈïøÂ∫¶
                        endRecord[20] = 0x00; endRecord[21] = 0x00;
                        
                        zip.set(endRecord, offset);
                        offset += 22;
                        
                        // Êà™Êñ≠Âà∞ÂÆûÈôÖÂ§ßÂ∞è
                        var finalZip = new Uint8Array(offset);
                        finalZip.set(zip.subarray(0, offset));
                        
                        // ÂàõÂª∫Blob
                        var blob = new Blob([finalZip], { type: "application/zip" });
                        resolve(blob);
                        
                    } catch (error) {
                        reject(error);
                    }
                }.bind(this));
            };
            
            // ÁÆÄÂåñÁöÑgenerateÊñπÊ≥ï
            this.generate = function(options, onUpdate) {
                return this.generateAsync(options);
            };
        };
        
        // ‰∏∫JSZipÊ∑ªÂä†ÈùôÊÄÅÊñπÊ≥ï
        JSZip.prototype = {
            constructor: JSZip
        };
        
        // ÂàõÂª∫‰∏Ä‰∏™ÂÖ®Â±ÄJSZipÂÆû‰æã
        if (!window.JSZip) {
            window.JSZip = function() {
                return new JSZip();
            };
            window.JSZip.prototype = JSZip.prototype;
        }
    </script>
</body>
</html>